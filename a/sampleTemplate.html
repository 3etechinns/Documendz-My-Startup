

<!DOCTYPE html>
<html ng-controller="templateController">

<head>
    <meta charset="utf-8">
    <meta name="generator" content="pdf2htmlEX">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link rel="stylesheet" type="text/css" href="../css/contextmenu.css">
    <link rel="stylesheet" type="text/css" href="../css/documendz.css?var=30122014">

    







    <style type="text/css">
        /* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab filetype=css: */
        /*! 
 * Base CSS for pdf2htmlEX
 * Copyright 2012,2013 Lu Wang <coolwanglu@gmail.com> 
 * https://github.com/coolwanglu/pdf2htmlEX/blob/master/share/LICENSE
 */
        /* Part 1: Web Page Layout: Free to modify, except for a few of them which are required by pdf2htmlEX.js, see the comments */
        
        #sidebar {
            /* Sidebar */
            
            position: absolute;
            top: 35px;
            left: 0;
            bottom: 0;
            width: 200px;
            padding: 0;
            margin: 0px;
            overflow: hidden;
        }
        #page-container {
            /* PDF container */
            
            position: absolute;
            /* required for calulating relative positions of pages in pdf2htmlEX.js */
            
            top: 35px;
            left: 0px;
            margin: 0;
            padding: 0;
            border: 0;
            /* required for lazy page loading in pdf2htmlEX.js (page visibility test) */
        }
        @media screen {
            /* for sidebar */
            
            #sidebar.opened + #page-container {
                left: 200px;
            }
            #page-container {
                /* `bottom' and `right' are required for lazy page loading in pdf2htmlEX.js (page visibility test)
     * alternatively you may set width and height
     */
                
                bottom: 0;
                right: 0;
                overflow: auto;
            }
            .loading-indicator {
                display: none;
            }
            .loading-indicator.active {
                display: block;
                position: absolute;
                width: 64px;
                height: 64px;
                top: 50%;
                left: 50%;
                margin-top: -32px;
                margin-left: -32px;
            }
            .loading-indicator img {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
            }
        }
        @media print {
            @page {
                margin: 0;
            }
            html {
                margin: 0;
            }
            body {
                margin: 0;
                -webkit-print-color-adjust: exact;
                /* enable printing background images for WebKit */
            }
            #sidebar {
                display: none;
            }
            #page-container {
                width: auto;
                height: auto;
                overflow: visible;
                background-color: transparent;
            }
            .d {
                display: none;
            }
        }
        /* Part 2: Page Elements: Modify with caution
 * The followings are base classes, some of which are meant to be override by PDF specific classes
 * So do not increase the specificity (e.g. ".classname" -> "#page-container .classname")
 */
        
        .pf {
            /* page */
            
            position: relative;
            background-color: white;
            overflow: hidden;
            margin: 0;
            border: 0;
            /* required by pdf2htmlEX.js for page visibility test */
        }
        .pc {
            /* content of a page */
            
            position: absolute;
            border: 0;
            padding: 0;
            margin: 0;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: block;
            /* set transform-origin for scaling */
            
            transform-origin: 0% 0%;
            -ms-transform-origin: 0% 0%;
            -webkit-transform-origin: 0% 0%;
        }
        .pc.opened {
            /* used by pdf2htmlEX.js, to show/hide pages */
            
            display: block;
        }
        .bf {
            /* images that occupies the whole page */
            
            position: absolute;
            border: 0;
            margin: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            -ms-user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .bi {
            /* images that cover only a part of the page */
            
            position: absolute;
            border: 0;
            margin: 0;
            -ms-user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            user-select: none;
        }
        @media print {
            .pf {
                margin: 0;
                box-shadow: none;
                page-break-after: always;
                page-break-inside: avoid;
            }
            @-moz-document url-prefix() {
                /* fix page truncation for FireFox */
                
                .pf {
                    overflow: visible;
                    border: 1px solid #FFFFFF;
                }
                .pc {
                    overflow: visible;
                }
            }
        }
        .c {
            /* clip box */
            
            position: absolute;
            border: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
            display: block;
        }
        .t {
            /* text line */
            
            position: absolute;
            white-space: pre;
            font-size: 1px;
            transform-origin: 0% 100%;
            -ms-transform-origin: 0% 100%;
            -webkit-transform-origin: 0% 100%;
            unicode-bidi: bidi-override;
            /* For rtl lanauges, e.g. Hebrew, we don't want the default Unicode behaviour */
            
            -moz-font-feature-settings: "liga" 0;
            /* We don't want Firefox to recognize ligatures */
        }
        span {
            /* text blocks within a line */
            
            position: relative;
            vertical-align: baseline;
            /* _<id> for spaces may need display:inline, which will override this */
            
            display: inline-block;
            unicode-bidi: bidi-override;
            /* For rtl lanauges, e.g. Hebrew, we don't want the default Unicode behaviour */
        }
        ._ {
            /* text shift */
            
            color: transparent;
            z-index: -1;
        }
        /* selection background should not be opaque, for fallback mode */
        
        ::selection {
            background: rgba(127, 255, 255, 0.4);
        }
        ::-moz-selection {
            background: rgba(127, 255, 255, 0.4);
        }
        .pi {
            /* info for Javascript */
            
            display: none;
        }
        .l {
            /* annotation links */
        }
        /* transparent color - WebKit */
        
        .d {
            /* css drawing */
            
            position: absolute;
            transform-origin: 0% 100%;
            -ms-transform-origin: 0% 100%;
            -webkit-transform-origin: 0% 100%;
        }
        /* Base CSS END */
    </style>
    <style type="text/css">
        /* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab filetype=css: */
        /*! 
 * Fancy styles for pdf2htmlEX
 * Copyright 2012,2013 Lu Wang <coolwanglu@gmail.com> 
 * https://github.com/coolwanglu/pdf2htmlEX/blob/master/share/LICENSE
 */
        
        @keyframes fadein {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @-webkit-keyframes fadein {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes swing {
            0% {
                transform: rotate(0deg);
            }
            10% {
                transform: rotate(0deg);
            }
            90% {
                transform: rotate(720deg);
            }
            100% {
                transform: rotate(720deg);
            }
        }
        @-webkit-keyframes swing {
            0% {
                -webkit-transform: rotate(0deg);
            }
            10% {
                -webkit-transform: rotate(0deg);
            }
            90% {
                -webkit-transform: rotate(720deg);
            }
            100% {
                -webkit-transform: rotate(720deg);
            }
        }
        @media screen {
            #sidebar {
                background-color: white;
                /* modified from http://philbit.com/svgpatterns/#crossstripes */
            }
            #outline {
                font-family: Georgia, Times, "Times New Roman", serif;
                font-size: 13px;
                margin: 2em 1em;
            }
            #outline ul {
                padding: 0;
            }
            #outline li {
                list-style-type: none;
                margin: 1em 0;
            }
            #outline li > ul {
                margin-left: 1em;
            }
            #outline a,
            #outline a:visited,
            #outline a:hover,
            #outline a:active {
                line-height: 1.2;
                color: #e8e8e8;
                text-overflow: ellipsis;
                white-space: nowrap;
                text-decoration: none;
                display: block;
                overflow: hidden;
                outline: 0;
            }
            #outline a:hover {
                color: rgb(0, 204, 255);
            }
            #page-container {
                background-color: #ede9e9;
                /* http://philbit.com/svgpatterns/#thinstripes */
                
                -webkit-transition: left 500ms;
                transition: left 500ms;
            }
            .pf {
                margin: 13px auto;
                box-shadow: 1px 1px 3px 1px #333;
                /* Needed by IE to make box-shadow works * https://developer.mozilla.org/en-US/docs/Web/CSS/box-shadow */
                
                border-collapse: separate;
            }
            .pc.opened {
                /* used by pdf2htmlEX.js, to show/hide pages */
                
                -webkit-animation: fadein 100ms;
                animation: fadein 100ms;
            }
            .loading-indicator.active {
                /* 
     * use 0.01s instead of 0s,
     * since YUI Compressor will change 0s to 0,
     * which is not recognized by Firefox
     */
                
                -webkit-animation: swing 1.5s ease-in-out 0.01s infinite alternate none;
                animation: swing 1.5s ease-in-out 0.01s infinite alternate none;
            }
        }
        /* Fancy CSS END */
    </style>

    <script>
        /*
                         Copyright 2012 Mozilla Foundation 
                         Copyright 2013 Lu Wang <coolwanglu@gmail.com>
                         Apachine License Version 2.0 
                        */
        (function() {
            function b(a, b, e, f) {
                var c = (a.className || "").split(/fs+/g);
                "" === c[0] && c.shift();
                var d = c.indexOf(b);
                0 > d && e && c.push(b);
                0 <= d && f && c.splice(d, 1);
                a.className = c.join(" ");
                return 0 <= d
            }
            if (!("classList" in document.createElement("div"))) {
                var e = {
                    add: function(a) {
                        b(this.element, a, !0, !1)
                    },
                    contains: function(a) {
                        return b(this.element, a, !1, !1)
                    },
                    remove: function(a) {
                        b(this.element, a, !1, !0)
                    },
                    toggle: function(a) {
                        b(this.element, a, !0, !0)
                    }
                };
                Object.defineProperty(HTMLElement.prototype, "classList", {
                    get: function() {
                        if (this._classList) return this._classList;
                        var a = Object.create(e, {
                            element: {
                                value: this,
                                writable: !1,
                                enumerable: !0
                            }
                        });
                        Object.defineProperty(this, "_classList", {
                            value: a,
                            writable: !1,
                            enumerable: !1
                        });
                        return a
                    },
                    enumerable: !0
                })
            }
        })();
    </script>
    <script>
        /* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab filetype=javascript : */
        /** 
         * @license pdf2htmlEX.js: Core UI functions for pdf2htmlEX
         * Copyright 2012,2013 Lu Wang <coolwanglu@gmail.com> and other contributors
         * https://github.com/coolwanglu/pdf2htmlEX/blob/master/share/LICENSE
         */

        /*
         * Attention:
         * This files is to be optimized by closure-compiler,
         * so pay attention to the forms of property names:
         *
         * string/bracket form is safe, won't be optimized:
         * var obj={ 'a':'b' }; obj['a'] = 'b';
         * name/dot form will be optimized, the name is likely to be modified:
         * var obj={ a:'b' }; obj.a = 'b';
         *
         * Either form can be used for internal objects,
         * but must be consistent for each one respectively.
         *
         * string/bracket form must be used for external objects
         * e.g. DEFAULT_CONFIG, object stored in page-data
         * property names are part of the `protocol` in these cases.
         *
         */

        'use strict';

        var pdf2htmlEX = window['pdf2htmlEX'] = window['pdf2htmlEX'] || {};

        /** 
         * @const
         * @struct
         */
        var CSS_CLASS_NAMES = {
            page_frame: 'pf',
            page_content_box: 'pc',
            page_data: 'pi',
            background_image: 'bi',
            link: 'l',
            __dummy__: 'no comma'
        };

        /** 
         * configurations of Viewer
         * @const
         * @dict
         */
        var DEFAULT_CONFIG = {
            // id of the element to put the pages in
            'container_id': 'svg-container',
            // id of the element for sidebar (to open and close)
            'sidebar_id': 'sidebar',
            // id of the element for outline
            'outline_id': 'outline',
            // class for the loading indicator
            'loading_indicator_cls': 'loading-indicator',
            // How many page shall we preload that are below the last visible page
            'preload_pages': 3,
            // how many ms should we wait before actually rendering the pages and after a scroll event
            'render_timeout': 100,
            // zoom ratio step for each zoom in/out event
            'scale_step': 0.9,
            // register global key handler
            'key_handler': true,
            // register hashchange handler
            'hashchange_handler': true,

            '__dummy__': 'no comma'
        };

        /** @const */
        var EPS = 1e-6;

        /************************************/
        /* utility function */
        /**
         * @param{Array.<number>} ctm
         */
        function invert(ctm) {
            var det = ctm[0] * ctm[3] - ctm[1] * ctm[2];
            return [ctm[3] / det, -ctm[1] / det, -ctm[2] / det, ctm[0] / det, (ctm[2] * ctm[5] - ctm[3] * ctm[4]) / det, (ctm[1] * ctm[4] - ctm[0] * ctm[5]) / det];
        };
        /**
         * @param{Array.<number>} ctm
         * @param{Array.<number>} pos
         */
        function transform(ctm, pos) {
            return [ctm[0] * pos[0] + ctm[2] * pos[1] + ctm[4], ctm[1] * pos[0] + ctm[3] * pos[1] + ctm[5]];
        };

        /**
         * @param{Element} ele
         */
        function get_page_number(ele) {
            return parseInt(ele.getAttribute('data-page-no'), 16);
        };

        /**
         * @param{NodeList} eles
         */
        function disable_dragstart(eles) {
            for (var i = 0, l = eles.length; i < l; ++i) {
                eles[i].addEventListener('dragstart', function() {
                    return false;
                }, false);
            }
        };

        /**
         * @param{...Object} var_args
         */
        function clone_and_extend_objs(var_args) {
            var result_obj = {};
            for (var i = 0, l = arguments.length; i < l; ++i) {
                var cur_obj = arguments[i];
                for (var k in cur_obj) {
                    if (cur_obj.hasOwnProperty(k)) {
                        result_obj[k] = cur_obj[k];
                    }
                }
            }
            return result_obj;
        };

        /** 
         * @constructor
         * @param{Element} page The element for the page
         */
        function Page(page) {
            if (!page) return;

            this.loaded = false;
            this.shown = false;
            this.page = page; // page frame element

            this.num = get_page_number(page);

            // page size
            // Need to make rescale work when page_content_box is not loaded, yet
            this.original_height = page.clientHeight;
            this.original_width = page.clientWidth;

            // content box
            var content_box = page.getElementsByClassName(CSS_CLASS_NAMES.page_content_box)[0];

            // if page is loaded
            if (content_box) {
                this.content_box = content_box;
                /*
                 * scale ratios
                 *
                 * original_scale : the first one
                 * cur_scale : currently using
                 */
                this.original_scale = this.cur_scale = this.original_height / content_box.clientHeight;
                this.page_data = JSON.parse(page.getElementsByClassName(CSS_CLASS_NAMES.page_data)[0].getAttribute('data-data'));

                this.ctm = this.page_data['ctm'];
                this.ictm = invert(this.ctm);

                this.loaded = true;
            }
        };
        Page.prototype = {
            /* hide & show are for contents, the page frame is still there */
            hide: function() {
                if (this.loaded && this.shown) {
                    this.content_box.classList.remove('opened');
                    this.shown = false;
                }
            },
            show: function() {
                if (this.loaded && !this.shown) {
                    this.content_box.classList.add('opened');
                    this.shown = true;
                }
            },
            /**
             * @param{number} ratio
             */
            rescale: function(ratio) {
                if (ratio === 0) {
                    // reset scale
                    this.cur_scale = this.original_scale;
                } else {
                    this.cur_scale = ratio;
                }

                // scale the content box
                if (this.loaded) {
                    var cbs = this.content_box.style;
                    cbs.msTransform = cbs.webkitTransform = cbs.transform = 'scale(' + this.cur_scale.toFixed(3) + ')';
                }

                // stretch the page frame to hold the place
                {
                    var ps = this.page.style;
                    ps.height = (this.original_height * this.cur_scale) + 'px';
                    ps.width = (this.original_width * this.cur_scale) + 'px';
                }
            },
            /*
             * return the coordinate of the top-left corner of container
             * in our coordinate system
             * assuming that p.parentNode === p.offsetParent
             */
            view_position: function() {
                var p = this.page;
                var c = p.parentNode;
                return [c.scrollLeft - p.offsetLeft - p.clientLeft, c.scrollTop - p.offsetTop - p.clientTop];
            },
            height: function() {
                return this.page.clientHeight;
            },
            width: function() {
                return this.page.clientWidth;
            }
        };

        /** 
         * @constructor
         * @param{Object=} config
         */
        function Viewer(config) {
            this.config = clone_and_extend_objs(DEFAULT_CONFIG, (arguments.length > 0 ? config : {}));
            this.pages_loading = [];
            this.init_before_loading_content();

            var self = this;
            document.addEventListener('DOMContentLoaded', function() {
                self.init_after_loading_content();
            }, false);
        };

        Viewer.prototype = {
            scale: 1,
            /* 
             * index of the active page (the one with largest visible area)
             * which estimates the page currently being viewed
             */
            cur_page_idx: 0,

            /*
             * index of the first visible page
             * used when determining current view
             */
            first_page_idx: 0,

            init_before_loading_content: function() {
                /* hide all pages before loading, will reveal only visible ones later */
                this.pre_hide_pages();
            },

            init_after_loading_content: function() {
                this.sidebar = document.getElementById(this.config['sidebar_id']);
                this.outline = document.getElementById(this.config['outline_id']);
                this.container = document.getElementById(this.config['container_id']);
                this.loading_indicator = document.getElementsByClassName(this.config['loading_indicator_cls'])[0];


                {
                    // Open the outline if nonempty
                    var empty = true;
                    var nodes = this.outline.childNodes;
                    for (var i = 0, l = nodes.length; i < l; ++i) {
                        var cur_node = nodes[i];
                        if (cur_node.nodeName === 'UL') {
                            empty = false;
                            break;
                        }
                    }
                    if (!empty)
                        this.sidebar.classList.add('opened');
                }

                this.find_pages();
                // do nothing if there's nothing
                if (this.pages.length == 0) return;

                // disable dragging of background images
                disable_dragstart(document.getElementsByClassName(CSS_CLASS_NAMES.background_image));

                if (this.config['key_handler'])
                    this.register_key_handler();

                var self = this;

                if (this.config['hashchange_handler']) {
                    window.addEventListener('hashchange', function(e) {
                        self.navigate_to_dest(document.location.hash.substring(1));
                    }, false);
                }

                // register schedule rendering
                // renew old schedules since scroll() may be called frequently
                this.container.addEventListener('scroll', function() {
                    self.update_page_idx();
                    self.schedule_render(true);
                }, false);

                // handle links
                [this.container, this.outline].forEach(function(ele) {
                    ele.addEventListener('click', self.link_handler.bind(self), false);
                });

                this.render();
            },

            /*
             * set up this.pages and this.page_map
             * pages is an array holding all the Page objects
             * page-Map maps an original page number (in PDF) to the corresponding index in page
             */
            find_pages: function() {
                var new_pages = [];
                var new_page_map = {};
                var nodes = this.container.childNodes;
                for (var i = 0, l = nodes.length; i < l; ++i) {
                    var cur_node = nodes[i];
                    if ((cur_node.nodeType === Node.ELEMENT_NODE) && cur_node.classList.contains(CSS_CLASS_NAMES.page_frame)) {
                        var p = new Page(cur_node);
                        new_pages.push(p);
                        new_page_map[p.num] = new_pages.length - 1;
                    }
                }
                this.pages = new_pages;
                this.page_map = new_page_map;
            },

            /**
             * @param{number} idx
             * @param{number=} pages_to_preload
             * @param{function(Page)=} callback
             *
             * TODO: remove callback -> promise ?
             */
            load_page: function(idx, pages_to_preload, callback) {
                var pages = this.pages;
                if (idx >= pages.length)
                    return; // Page does not exist

                var cur_page = pages[idx];
                if (cur_page.loaded)
                    return; // Page is loaded

                if (this.pages_loading[idx])
                    return; // Page is already loading

                var cur_page_ele = cur_page.page;
                var url = cur_page_ele.getAttribute('data-page-url');
                if (url) {
                    this.pages_loading[idx] = true; // set semaphore

                    // add a copy of the loading indicator
                    var new_loading_indicator = this.loading_indicator.cloneNode();
                    new_loading_indicator.classList.add('active');
                    cur_page_ele.appendChild(new_loading_indicator);

                    // load data
                    {
                        var self = this;
                        var _idx = idx;
                        var xhr = new XMLHttpRequest();
                        xhr.open('GET', url, true);
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState != 4) return;
                            if (xhr.status === 200) {
                                // find the page element in the data
                                var div = document.createElement('div');
                                div.innerHTML = xhr.responseText;

                                var new_page = null;
                                var nodes = div.childNodes;
                                for (var i = 0, l = nodes.length; i < l; ++i) {
                                    var cur_node = nodes[i];
                                    if ((cur_node.nodeType === Node.ELEMENT_NODE) && cur_node.classList.contains(CSS_CLASS_NAMES.page_frame)) {
                                        new_page = cur_node;
                                        break;
                                    }
                                }

                                // replace the old page with loaded data
                                // the loading indicator on this page should also be destroyed
                                var p = self.pages[_idx];
                                self.container.replaceChild(new_page, p.page);
                                p = new Page(new_page);
                                self.pages[_idx] = p;

                                p.hide();
                                p.rescale(self.scale);

                                // disable background image dragging
                                disable_dragstart(new_page.getElementsByClassName(CSS_CLASS_NAMES.background_image));

                                self.schedule_render(false);

                                if (callback) {
                                    callback(p);
                                }
                            }

                            // Reset loading token
                            delete self.pages_loading[_idx];
                        };
                        xhr.send(null);
                    }
                }
                // Concurrent prefetch of the next pages
                if (pages_to_preload === undefined)
                    pages_to_preload = this.config['preload_pages'];

                if (--pages_to_preload > 0) {
                    var self = this;
                    setTimeout(function() {
                        self.load_page(idx + 1, pages_to_preload);
                    }, 0);
                }
            },

            /*
             * Hide all pages that have no 'opened' class
             * The 'opened' class will be added to visible pages by JavaScript
             * We cannot add this in the default CSS because JavaScript may be disabled
             */
            pre_hide_pages: function() {
                /* pages might have not been loaded yet, so add a CSS rule */
                var s = '@media screen{.' + CSS_CLASS_NAMES.page_content_box + '{display:none;}}';
                var n = document.createElement('style');
                if (n.styleSheet) {
                    n.styleSheet.cssText = s;
                } else {
                    n.appendChild(document.createTextNode(s));
                }
                document.head.appendChild(n);
            },

            /*
             * show visible pages and hide invisible pages
             */
            render: function() {
                var container = this.container;
                /* 
                 * show the pages that are 'nearly' visible -- it's right above or below the container
                 *
                 * all the y values are in the all-page element's coordinate system
                 */
                var container_min_y = container.scrollTop;
                var container_height = container.clientHeight;
                var container_max_y = container_min_y + container_height;
                var visible_min_y = container_min_y - container_height;
                var visible_max_y = container_max_y + container_height;

                var cur_page_fully_visible = false;
                var cur_page_idx = this.cur_page_idx;
                var max_visible_page_idx = cur_page_idx;
                var max_visible_ratio = 0.0;

                var pl = this.pages;
                for (var i = 0, l = pl.length; i < l; ++i) {
                    var cur_page = pl[i];
                    var cur_page_ele = cur_page.page;
                    var page_min_y = cur_page_ele.offsetTop + cur_page_ele.clientTop;
                    var page_height = cur_page_ele.clientHeight;
                    var page_max_y = page_min_y + page_height;
                    if ((page_min_y <= visible_max_y) && (page_max_y >= visible_min_y)) {
                        // cur_page is 'nearly' visible, show it or load it
                        if (cur_page.loaded) {
                            cur_page.show();
                        } else {
                            this.load_page(i);
                        }
                    } else {
                        cur_page.hide();
                    }
                }
            },
            /*
             * update cur_page_idx and first_page_idx
             * normally called upon scrolling
             */
            update_page_idx: function() {
                var pages = this.pages;
                var pages_len = pages.length;
                // there is no chance that cur_page_idx or first_page_idx is modified
                if (pages_len < 2) return;

                var container = this.container;
                var container_min_y = container.scrollTop;
                var container_max_y = container_min_y + container.clientHeight;

                // binary search for the first page
                // whose bottom border is below the top border of the container
                var first_idx = -1;
                var last_idx = pages_len;
                var rest_len = last_idx - first_idx;
                // TODO: use current first_page_idx as a hint?
                while (rest_len > 1) {
                    var idx = first_idx + Math.floor(rest_len / 2);
                    var cur_page_ele = pages[idx].page;
                    if (cur_page_ele.offsetTop + cur_page_ele.clientTop + cur_page_ele.clientHeight >= container_min_y) {
                        last_idx = idx;
                    } else {
                        first_idx = idx;
                    }
                    rest_len = last_idx - first_idx;
                }

                /*
                 * with malformed settings it is possible that no page is visible, e.g.
                 * - the container is to thin, which lies in the margin between two pages
                 * - all pages are completely above or below the container
                 * but we just assume that they won't happen.
                 */
                this.first_page_idx = last_idx;

                // find the page with largest visible area
                var cur_page_idx = this.cur_page_idx;
                var max_visible_page_idx = cur_page_idx;
                var max_visible_ratio = 0.0;

                for (var i = last_idx; i < pages_len; ++i) {
                    var cur_page_ele = pages[i].page;
                    var page_min_y = cur_page_ele.offsetTop + cur_page_ele.clientTop;
                    var page_height = cur_page_ele.clientHeight;
                    var page_max_y = page_min_y + page_height;
                    if (page_min_y > container_max_y) break;

                    // check the visible fraction of the page
                    var page_visible_ratio = (Math.min(container_max_y, page_max_y) - Math.max(container_min_y, page_min_y)) / page_height;

                    // stay with the current page if it is still fully visible
                    if ((i === cur_page_idx) && (Math.abs(page_visible_ratio - 1.0) <= EPS)) {
                        max_visible_page_idx = cur_page_idx;
                        break;
                    }

                    if (page_visible_ratio > max_visible_ratio) {
                        max_visible_ratio = page_visible_ratio;
                        max_visible_page_idx = i;
                    }
                }

                this.cur_page_idx = max_visible_page_idx;
            },

            /**
             * @param{boolean} renew renew the existing schedule instead of using the old one
             */
            schedule_render: function(renew) {
                if (this.render_timer !== undefined) {
                    if (!renew) return;
                    clearTimeout(this.render_timer);
                }

                var self = this;
                this.render_timer = setTimeout(function() {
                    /*
                     * render() may trigger load_page(), which may in turn trigger another render()
                     * so delete render_timer first
                     */
                    delete self.render_timer;
                    self.render();
                }, this.config['render_timeout']);
            },

            /*
             * Handling key events, zooming, scrolling etc.
             */
            register_key_handler: function() {
                /* 
                 * When user try to zoom in/out using ctrl + +/- or mouse wheel
                 * handle this and prevent the default behaviours
                 *
                 * Code credit to PDF.js
                 */
                var self = this;

                // Firefox specific event, so that we can prevent browser from zooming
                window.addEventListener('DOMMouseScroll', function(e) {
                    if (e.ctrlKey) {
                        e.preventDefault();
                        var container = self.container;
                        var rect = container.getBoundingClientRect();
                        var fixed_point = [e.clientX - rect['left'] - container.clientLeft, e.clientY - rect['top'] - container.clientTop];
                        self.rescale(Math.pow(self.config['scale_step'], e.detail), true, fixed_point);
                    }
                }, false);

                window.addEventListener('keydown', function(e) {
                    var handled = false;
                    /*
                    var cmd = (e.ctrlKey ? 1 : 0)
                              | (e.altKey ? 2 : 0)
                              | (e.shiftKey ? 4 : 0)
                              | (e.metaKey ? 8 : 0)
                              ;
                              */
                    var with_ctrl = e.ctrlKey || e.metaKey;
                    var with_alt = e.altKey;
                    switch (e.keyCode) {
                        case 61: // FF/Mac '='
                        case 107: // FF '+' and '='
                        case 187: // Chrome '+'
                            if (with_ctrl) {
                                self.rescale(1.0 / self.config['scale_step'], true);
                                handled = true;
                            }
                            break;
                        case 173: // FF/Mac '-'
                        case 109: // FF '-'
                        case 189: // Chrome '-'
                            if (with_ctrl) {
                                self.rescale(self.config['scale_step'], true);
                                handled = true;
                            }
                            break;
                        case 48: // '0'
                            if (with_ctrl) {
                                self.rescale(0, false);
                                handled = true;
                            }
                            break;
                        case 33: // Page UP:
                            if (with_alt) { // alt-pageup    -> scroll one page up
                                self.scroll_to(self.cur_page_idx - 1);
                            } else { // pageup        -> scroll one screen up
                                self.container.scrollTop -= self.container.clientHeight;
                            }
                            handled = true;
                            break;
                        case 34: // Page DOWN
                            if (with_alt) { // alt-pagedown  -> scroll one page down
                                self.scroll_to(self.cur_page_idx + 1);
                            } else { // pagedown      -> scroll one screen down
                                self.container.scrollTop += self.container.clientHeight;
                            }
                            handled = true;
                            break;
                        case 35: // End
                            self.container.scrollTop = self.container.scrollHeight;
                            handled = true;
                            break;
                        case 36: // Home
                            self.container.scrollTop = 0;
                            handled = true;
                            break;
                    }
                    if (handled) {
                        e.preventDefault();
                        return;
                    }
                }, false);
            },

            /**
             * @param{number} ratio
             * @param{boolean} is_relative
             * @param{Array.<number>=} fixed_point preserve the position (relative to the top-left corner of the viewer) after rescaling
             */
            rescale: function(ratio, is_relative, fixed_point) {
                var old_scale = this.scale;
                var new_scale = old_scale;
                // set new scale
                if (ratio === 0) {
                    new_scale = 1;
                    is_relative = false;
                } else if (is_relative)
                    new_scale *= ratio;
                else
                    new_scale = ratio;

                this.scale = new_scale;

                if (!fixed_point)
                    fixed_point = [0, 0];

                // translate fixed_point to the coordinate system of all pages
                var container = this.container;
                fixed_point[0] += container.scrollLeft;
                fixed_point[1] += container.scrollTop;

                // find the visible page that contains the fixed point
                // if the fixed point lies between two pages (including their borders), it's contained in the first one
                var pl = this.pages;
                var pl_len = pl.length;
                for (var i = this.first_page_idx; i < pl_len; ++i) {
                    var p = pl[i].page;
                    if (p.offsetTop + p.clientTop >= fixed_point[1])
                        break;
                }
                var fixed_point_page_idx = i - 1;

                // determine the new scroll position
                // each-value consists of two parts, one inside the page, which is affected by rescaling,
                // the other is outside, (e.g. borders and margins), which is not affected

                // if the fixed_point is above the first page, use the first page as the reference
                if (fixed_point_page_idx < 0)
                    fixed_point_page_idx = 0;

                var fp_p = pl[fixed_point_page_idx].page;
                var fp_p_width = fp_p.clientWidth;
                var fp_p_height = fp_p.clientHeight;

                var fp_x_ref = fp_p.offsetLeft + fp_p.clientLeft;
                var fp_x_inside = fixed_point[0] - fp_x_ref;
                if (fp_x_inside < 0)
                    fp_x_inside = 0;
                else if (fp_x_inside > fp_p_width)
                    fp_x_inside = fp_p_width;

                var fp_y_ref = fp_p.offsetTop + fp_p.clientTop;
                var fp_y_inside = fixed_point[1] - fp_y_ref;
                if (fp_y_inside < 0)
                    fp_y_inside = 0;
                else if (fp_y_inside > fp_p_height)
                    fp_y_inside = fp_p_height;

                // Rescale pages
                for (var i = 0; i < pl_len; ++i)
                    pl[i].rescale(new_scale);

                // Correct container scroll to keep view aligned while zooming
                container.scrollLeft += fp_x_inside / old_scale * new_scale + fp_p.offsetLeft + fp_p.clientLeft - fp_x_inside - fp_x_ref;
                container.scrollTop += fp_y_inside / old_scale * new_scale + fp_p.offsetTop + fp_p.clientTop - fp_y_inside - fp_y_ref;

                // some pages' visibility may be toggled, wait for next render()
                // renew old schedules since rescale() may be called frequently
                this.schedule_render(true);
            },

            fit_width: function() {
                var page_idx = this.cur_page_idx;
                this.rescale(this.container.clientWidth / this.pages[page_idx].width(), false);
                this.scroll_to(page_idx);
            },

            fit_height: function() {
                var page_idx = this.cur_page_idx;
                this.rescale(this.container.clientHeight / this.pages[page_idx].height(), false);
                this.scroll_to(page_idx);
            },
            /**
             * @param{Node} ele
             */
            get_containing_page: function(ele) {
                /* get the page obj containing obj */
                while (ele) {
                    if ((ele.nodeType === Node.ELEMENT_NODE) && ele.classList.contains(CSS_CLASS_NAMES.page_frame)) {
                        /*
                         * Get original page number and map it to index of pages
                         * TODO: store the index on the dom element
                         */
                        var pn = get_page_number( /** @type{Element} */ (ele));
                        var pm = this.page_map;
                        return (pn in pm) ? this.pages[pm[pn]] : null;
                    }
                    ele = ele.parentNode;
                }
                return null;
            },

            /**
             * @param{Event} e
             */
            link_handler: function(e) {
                var target = /** @type{Node} */ (e.target);
                var detail_str = /** @type{string} */ (target.getAttribute('data-dest-detail'));
                if (!detail_str) return;

                this.navigate_to_dest(detail_str, this.get_containing_page(target));
                e.preventDefault();
            },

            /**
             * @param{string} detail_str may come from user provided hashtag, need sanitzing
             * @param{Page=} src_page page containing the source event (e.g. link)
             */
            navigate_to_dest: function(detail_str, src_page) {
                try {
                    var detail = JSON.parse(detail_str);
                } catch (e) {
                    return;
                }

                if (!(detail instanceof Array)) return;

                var target_page_no = detail[0];
                var page_map = this.page_map;
                if (!(target_page_no in page_map)) return;
                var target_page_idx = page_map[target_page_no];
                var target_page = this.pages[target_page_idx];

                for (var i = 2, l = detail.length; i < l; ++i) {
                    var d = detail[i];
                    if (!((d === null) || (typeof d === 'number')))
                        return;
                }

                while (detail.length < 6)
                    detail.push(null);

                // cur_page might be undefined, e.g. from Outline
                var cur_page = src_page || this.pages[this.cur_page_idx];

                var cur_pos = cur_page.view_position();
                cur_pos = transform(cur_page.ictm, [cur_pos[0], cur_page.height() - cur_pos[1]]);

                var zoom = this.scale;
                var pos = [0, 0];
                var upside_down = true;
                var ok = false;

                // position specified in `detail` are in the raw coordinate system of the page (unscaled)
                var scale = this.scale;
                // TODO: fitb*
                // TODO: BBox
                switch (detail[1]) {
                    case 'XYZ':
                        pos = [(detail[2] === null) ? cur_pos[0] : detail[2] * scale, (detail[3] === null) ? cur_pos[1] : detail[3] * scale];
                        zoom = detail[4];
                        if ((zoom === null) || (zoom === 0))
                            zoom = this.scale;
                        ok = true;
                        break;
                    case 'Fit':
                    case 'FitB':
                        pos = [0, 0];
                        ok = true;
                        break;
                    case 'FitH':
                    case 'FitBH':
                        pos = [0, (detail[2] === null) ? cur_pos[1] : detail[2] * scale];
                        ok = true;
                        break;
                    case 'FitV':
                    case 'FitBV':
                        pos = [(detail[2] === null) ? cur_pos[0] : detail[2] * scale, 0];
                        ok = true;
                        break;
                    case 'FitR':
                        /* locate the top-left corner of the rectangle */
                        // TODO
                        pos = [detail[2] * scale, detail[5] * scale];
                        upside_down = false;
                        ok = true;
                        break;
                    default:
                        break;
                }

                if (!ok) return;

                this.rescale(zoom, false);


                var self = this;
                /**
                 * page should of type Page
                 * @param{Page} page
                 */
                var transform_and_scroll = function(page) {
                    pos = transform(page.ctm, pos);
                    if (upside_down) {
                        pos[1] = page.height() - pos[1];
                    }
                    self.scroll_to(target_page_idx, pos);
                };

                if (target_page.loaded) {
                    transform_and_scroll(target_page);
                } else {
                    // TODO: scroll_to may finish before load_page

                    // Scroll to the exact position once loaded.
                    this.load_page(target_page_idx, undefined, transform_and_scroll);

                    // In the meantime page gets loaded, scroll approximately position for maximum responsiveness.
                    this.scroll_to(target_page_idx);
                }
            },

            /**
             * @param{number} page_idx
             * @param{Array.<number>=} pos [x,y] where (0,0) is the top-left corner
             */
            scroll_to: function(page_idx, pos) {
                var pl = this.pages;
                if ((page_idx < 0) || (page_idx >= pl.length)) return;
                var target_page = pl[page_idx];
                var cur_target_pos = target_page.view_position();

                if (pos === undefined)
                    pos = [0, 0];

                var container = this.container;
                container.scrollLeft += pos[0] - cur_target_pos[0];
                container.scrollTop += pos[1] - cur_target_pos[1];
            }
        };

        // export pdf2htmlEX.Viewer
        pdf2htmlEX['Viewer'] = Viewer;
    </script>
    <script>
        try {
            pdf2htmlEX.defaultViewer = new pdf2htmlEX.Viewer({});
        } catch (e) {}
    </script>


    <title></title>
</head>

<body>

    <div id="loading" >

        <img id="loading-image" src="../images/ajax-loader.gif" alt="Loading..." />
    </div>

    <div id="template-attributes" style="position: fixed;
top: 55px;
background: white;
height: 40px;
padding: 10px 25px;
width: 100%;
z-index: 2;">

<div id = "filenameInTemplate">{{templateFilename}}</div>

</div>


    <div id="tools-container" style="position: fixed;
top: 95px;
background: white;
height: auto;
padding: 5px 20px;
width: 100%;
z-index: 20;
box-shadow: 3px 6px 8px #888;
">

        <div class="tool-type">
            <input type="checkbox" id="strike" name="chk" onclick="check_value('strike')">
            <label for="strike"><i class="fa fa-strikethrough" style="float:left"></i>
                <div style="float:left;font-weight:200">&nbsp;Strike</div>
            </label>

        </div>
        <div class="tool-type">
            <input type="checkbox" id="highlight" onclick="check_value('highlight')">
            <label for="highlight"><i class="fa fa-paint-brush" style="float:left"></i>
                <div style="float:left;font-weight:200">&nbsp;Highlight</div>
            </label>
        </div>
        <div class="tool-type">
            <input type="checkbox" id="draw" onclick="check_value('draw')">
            <label for="draw"><i class="fa fa-pencil" style="float:left"></i>
                <div class="unselectable" style="float:left;font-weight:200">&nbsp;Draw</div>
            </label>
        </div>
        <div class="tool-type">
            <input type="checkbox" id="textbox" onclick="check_value('textbox')">
            <label for="textbox"><i class="fa fa-pencil-square-o" style="float:left"></i>
                <div style="float:left;font-weight:200">&nbsp;Text box</div>
            </label>
        </div>
        <div class="tool-type">
            <input type="checkbox" id="drop-comment" onclick="check_value('drop-comment')">
            <label for="drop-comment"><i class="fa fa-thumb-tack" style="float:left"></i>
                <div style="float:left;font-weight:200">&nbsp;Pin comment</div>
            </label>
        </div>
        <div class="tool-type">
            <input type="checkbox" id="drag-comment" onclick="check_value('drag-comment')">
            <label for="drag-comment"><i class="fa fa-comment" style="float:left"></i>
                <div style="float:left;font-weight:200;">&nbsp;Text comment</div>
            </label>
        </div>

        <div style="display:inline-block;float:right">
        <a href="#/workgroups/{{wg}}/{{uniqueFilename}}/activity" class="btn btn-warning btn-small"><i class="fa fa-bar-chart"></i>&nbsp;View activity</a>
    </div>

    </div>
    <div id="title" style="display:none;position:fixed;top:0px;left:0px;width:100%;height:35px;background-color: black; z-index:20 ;text-align:left;line-height: 35px;color:white;">

        <div id="del-info">
            <button class="close_info" type="button">
                <span></span>
                <span class="close_area">Close</span>
            </button>
            To delete an annotation: Select its type from tools, then right-click on the annotation
        </div>

        <div id="doc_name" style="text-align:center;font-size:14px;font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;"><img style="display: inline-block; vertical-align: sub;" src="../images/doc_name.png">
            <?php echo $_GET[ 'file']; ?>
        </div>
        <div id="page-text" style="position:absolute;top:0px;left:205px; color: white; -webkit-user-select: text;font-size:14px;font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;">Page:</div>
        <input id="page_no" type="text" onkeypress="return isNumber(event)" name="fname" style="margin-top: 6px;
width: 30px;
height: 12px;
font-size: 9pt;
position: absolute;
top: 5px;
-webkit-user-select: text;
left: 243px;
outline: none;
background-color: rgba(203, 198, 198, 0.8);
text-align: center;
border-radius: 4px;
opacity: 0.;
border: none;
color: white;
font-weight:bold;
font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;">


        <img id="page-up" style="position:absolute;top:11px;left:276px;cursor: pointer; -webkit-user-select: text;" src="../images/up15.png">
        </td>
        <img id="page-down" style="position:absolute;top:11px;left:294px;cursor: pointer; -webkit-user-select: text;" src="../images/down15.png">


       
        <div class="header-panel-btn" id="clear-all-history" style="position:absolute; top:4px; right: 94px; height:25px; width:68px;" onclick="if(confirm('Are you sure you want to delete all your annotations?')) clear_all_history(); else return false">Clear All</div>
        


    </div>


   <!--  <div id="sidebar" class="opened">

        
     </div>
 -->

       

            <div class="highlight_colors" style="display:none;
                                                position: absolute;
                                                top: 137px;
                                                left: 90px;
                                                z-index: 20;
                                                padding: 4px 4px;
                                                background: white;
                                                border: 1px solid grey;">
                <input type="radio" id="highlight_red" onclick="check_value('highlight_red')">
                <label for="highlight_red">
                    <div id="red_circle">
                            <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="highlight_blue" onclick="check_value('highlight_blue')">
                <label for="highlight_blue">
                    <div id="blue_circle">
                            <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="highlight_green" onclick="check_value('highlight_green')">
                <label for="highlight_green">
                    <div id="green_circle">
                                <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="highlight_yellow" onclick="check_value('highlight_yellow')">
                <label for="highlight_yellow">
                    <div id="yellow_circle">
                                <i class="fa fa-check"></i>
                    </div>
                </label>
            </div>

           

            <div class="draw_colors" style="display: none;
                                            position: absolute;
                                            top: 137px;
                                            left: 177px;
                                            z-index: 20;
                                            padding: 4px;
                                            border: 1px solid grey;
                                            background: white;">
                <input type="radio" id="draw_black" onclick="check_value('draw_black')">
                <label for="draw_black">
                    <div id="black_draw">
                                 <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="draw_red" onclick="check_value('draw_red')">
                <label for="draw_red">
                    <div id="red_draw">
                                 <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="draw_green" onclick="check_value('draw_green')">
                <label for="draw_green">
                    <div id="green_draw">
                                 <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="draw_blue" onclick="check_value('draw_blue')">
                <label for="draw_blue">
                    <div id="blue_draw">
                                 <i class="fa fa-check"></i>
                    </div>
                </label>
            </div>

<div style="z-index:20">
      <div id="display-history" style="position:absolute;top:280px;left:10px;">Annotation history</div>
        <!-- <div id ="count-history" style="position:absolute;top:287px;left:141px;color:white;font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;font-size:10pt"></div> -->
        <div id="down-drop" style="display:none;pointer-events:none;cursor:pointer;position:absolute;top:293px;left:152px;width: 0;height: 0;font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;border-left: 6px solid transparent;border-right: 6px solid transparent;border-top: 6px solid white;"></div>
        <div id="up-pull" style="display:none;pointer-events:none;cursor:pointer;position:absolute;top:293px;left:152px;width: 0;height: 0;font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;border-left: 6px solid transparent;border-right: 6px solid transparent;border-bottom: 6px solid white;"></div>



        <div id="count-history" style="position:absolute;top:271px;left:177px;"></div>

        <div id="history-container" style="position:relative;top:287px;left:10px;overflow:hidden;width:180px;height:280px">
            <ul id="history" style="position:relative;padding:0px;margin:0px;top:0px;left:0px;width:180px;height:281px;">

            </ul>
        </div>      
</div>


    <div id="page-container" style="margin-top: 100px;" >
        <div id="image-container" style="position:absolute;left:0px;width:100%;height:100%"></div>
        <div id="svg-container" class="clickable">



        </div>

        <div id="connector-container">
            <svg id="connector-svg" style="overflow:visible" height="100%" width="100%">


            </svg>
        </div>
        <div id="comment-container">
        </div>
    </div>
 
    


     <!-- <script type="text/javascript" src="../javascripts/socket.io.js"></script> -->
    


    <script language="javascript" type="text/javascript">
        var userId = "<?php echo $_SESSION['userid']?>";
        
var n = window.location.href;
var shareId = window.location.href.slice(-15);
var store = window.location.href.slice(-24,-16);

         // var socket;

         // socket.disconnect();

      // $(window).load(function(){     //Without this working fine 7th Jan 2015

            
        

        // socket = io.connect("http://192.168.0.104:9000");
// });


        // socket.on("connect", socketConnected);
        // socket.on("getChangeData", getChangeData);


$(document).ready(function() {
 // executes when complete page is fully loaded, including all frames, objects and images

setTimeout(function(){ // a 500ms timeout given so that it lands on the page then pulls the data

        var request = $.ajax({
            url: "https://d28kungomln1xp.cloudfront.net/sample/converts/"+store+".html",
            type: "GET",	
            cache: true,
            async: false
        });


        request.done(function(data) {

 

            $("#svg-container").ready(function() {


                $("#svg-container").html(data);
               

            //    console.log("jdhd");


				

            });


        });

        request.fail(function() {

            console.log("error Pulling File");
        });



        var pullRequest = $.ajax({
            url: "https://documendz.com:9000/pulldata/annotationdata/" + shareId,
            type: "GET",
            cache: false
        });



        pullRequest.done(function(data) {

           
             align_page();
             $('#loading').css({display:"none"});
            
            if (data.error) {
                console.log("Server Error Pulling data");

            } else if (data.data.length === 0) {
                console.log("No Data");
            } else {

                $("svg-container").ready(function() {

                    parseData(data.data[0]);


                });

            }

        });

        pullRequest.fail(function() {

            console.log("failed to pull");
        });



        //history REady ! pull History From server

        $("#display-history").ready(function() {

            var pullHistoryRequest = $.ajax({
                url: "https://documendz.com:9000/pulldata/historydata/" + shareId,
                type: "GET",
                cache: false,
            });

            pullHistoryRequest.done(function(data) {
                if (data.error) {

                    console.log("Server Error Pulling data")
                } else if (data.data.length === 0) {
                    console.log("No Data");
                } else {


                    $.each(data.data[0].history, function(index, value) {

                        add_history_realtime(value.append_class, value.append_text, value.page_no, value.anno_type, value.time, value.userName);
                    });
                }

            });

            pullHistoryRequest.fail(function() {

                console.log("Error Pulling History");
            });

        });


},500);
   
});     
    </script>

</body>

</html>

