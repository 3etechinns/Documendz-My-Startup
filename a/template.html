<!DOCTYPE html>
<html ng-controller="templateController">

<head>
    <meta charset="utf-8">
    <meta name="generator" content="pdf2htmlEX">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link rel="stylesheet" type="text/css" href="../css/contextmenu.css">
    <link rel="stylesheet" type="text/css" href="../css/documendz.css?var=30102014">
    <link rel="stylesheet" type="text/css" href="../css/perfect-scrollbar.min.css">
    <link rel="stylesheet" href="../css/introjs.min.css">





//     <script type="text/javascript"> 

   

//         var comm_del = 0;

//         window.shared_id = "<?php echo 140 ?>";
//         window.user = "<?php session_start(); echo $_SESSION['Username']; ?>";

       

//         function escapeHtml(text) {
//             var map = {
//                 '&': '&amp;',
//                 '<': '&lt;',
//                 '>': '&gt;',
//                 '"': '&quot;',
//                 "'": '&#039;'
//             };

// console.log("text is:" + text);

//             return text.replace(/[&<>"']/g, function(m) {
//                 return map[m];
//             });
//         }

//         function setSelection(a, d) {
//             if (document.createRange) {
//                 var b = document.createRange();
//                 c = window.getSelection();
//                 b.selectNodeContents(a);
//                 if (d) {
//                     b.collapse(false)
//                 }
//                 c.removeAllRanges();
//                 c.addRange(b);

//             } else {
//                 if (document.body.createTextRange) {
//                     var b = document.body.createTextRange();
//                     b.moveToElementText(a);
//                     if (d) {
//                         b.collapse(false)
//                     }
//                     b.select();

//                 }
//             }
//         }


//         function clear_all_history() {


//             $('#svg-container > .handle').remove(); /* Remove text boxes*/
//             $('#svg_id > path').remove();

//             var listItems = $("#history li");

//             listItems.each(function() {
//                     var x = $('.' + $(this).attr('class') + ' > #anno_type > b')[0].innerHTML;
//                     if ((x == "Pin comment") || (x == "Text comment")) {

//                         if ($("#comment-container").children().length == 1) {
//                             /* $('#svg-container').css({'position':'absolute','height':'auto','left': svg_left("before")}); */
//                             comm_del = 0;
//                         }

//                         var del_class = "." + $(this).attr('class');

//                         $("#svg_id > " + del_class).remove();
//                         $("#connector-svg > " + del_class).remove();
//                         $("#image-container > " + del_class).remove();
//                         $('#svg-container').textHighlighter();
//                         $('#svg-container').getHighlighter().removeHighlights("." + $(this).attr('class'), $(this).attr('class'));

//                         delete_commentbox_update_arrays($(del_class).children('.new-comment')[0]);

//                     }

//                     if ((x == "Strike") || (x == "Highlight")) {

//                         $('#svg-container').textHighlighter();
//                         $('#svg-container').getHighlighter().removeHighlights("." + $(this).attr('class'), $(this).attr('class'));
//                     }
//                 }

//             );

//             $("#history").empty(); /* Removes all Li from history */

//             $.contextMenu('destroy'); /* This and below paragraph brings doc to its original fresh state(as in all uncheck state) */
//             $('.highlight_colors').css('display', 'none');
//             $('.draw_colors').css('display', 'none');
//             $('#svg-container').textHighlighter();
//             $('#svg-container').getHighlighter().destroy();

//             change_sketchpads(0);
//             svg_cont_style("text");
//             document.getElementById("svg_id").style.pointerEvents = "none";
//             $('.clickable').unbind('click');
//             $('#svg-container').unbind();
//             $('#svg-container').css({
//                 "cursor": "text"
//             });
//             $("#draw, #strike,#textbox, #highlight, #drop-comment,#drag-comment, #highlight_blue, #highlight_red, #highlight_green, #highlight_yellow, #draw_black, #draw_red, #draw_green, #draw_blue").prop('checked', false);

//             // click_counter= -1;
//             // comment_div_id_cnt = -1; //id no. for comment boxes to be set to -1 again

//         }

//         function hideintro() {


//             $('#intro-modal').fadeOut("slow");
//             $(document).unbind('keyup');
//         }

//         function displayintro() {

//             $('#intro-modal').css("display", "block");
//             $('#intro-modal').css("opacity", "0.65");
//             $(document).bind('keyup', function(e) {

//                 if (($('#intro-modal').css("display") == "block") && (e.keyCode == 27)) {

//                     hideintro();
//                 }
//             });
//         }


//         function check_empty_commentbox(comment_type) {

//             $(".comment-box").each(function() {

//                 if ($(this).find('.active-comment').length == 1) {

//                     if ($.trim($(this).find('.active-comment').val()).length == 0) {



//                         if ($(this).children('li').length == 1) {


//                             var del_class = "." + $(this).attr('class').split(' ')[1];

//                             $("#svg_id > " + del_class).remove();
//                             $("#connector-svg > " + del_class).remove();
//                             $("#image-container > " + del_class).remove();
//                             $("#history > " + del_class).remove();
//                             $('#svg-container').textHighlighter();
//                             $('#svg-container').getHighlighter().removeHighlights(del_class, $(this).attr('class').split(' ')[1]);
//                             if ($('#strike').is(':checked') == true || $('#highlight').is(':checked') == true || $('#drag-comment').is(':checked') == true) {


//                             } else {

//                                 $('#svg-container').getHighlighter().destroy();
//                             }
//                             delete_commentbox_update_arrays($(this).children(".new-comment")[0]);
//                             comm_del = 1; //to set that the delete has happenend for an empty box, so the svg-container has not moved
//                         } else {

//                             $(this).children('li:last').remove();

//                             $(this).find('.new-comment').addClass('new-comm-active').removeClass('new-comm-inactive');
//                             $(this).find('.submit-comment').addClass('submit-inactive').removeClass('submit-active');

//                         }

//                     }
//                 }


//             });

//         }

//         function update_history(update_class, update_text, update_page) {

//             updateHistoryObject = {
//                 update_class: update_class,
//                 update_text: update_text,
//                 update_page: update_page
//             };

//             // console.log("update " + update_class);

//             sendChangeData(updateHistoryObject, "update-history");

//             if (update_text != undefined) {

//                 if (update_text.length > 25) {

//                     update_text = update_text.substring(0, 22) + "...";
//                 };

//                 $("#history").children("." + update_class).children('#matter').text(update_text);
//             }

//             if (update_page != undefined) {

//                 $("#history").children("." + update_class).children('#other').text("Page: " + update_page);

//             }

//         };

//         function update_history_realtime(update_class, update_text, update_page) {

//             updateHistoryObject = {
//                 update_class: update_class,
//                 update_text: update_text,
//                 update_page: update_page
//             };

//             if (update_text != undefined) {

//                 if (update_text.length > 25) {

//                     update_text = update_text.substring(0, 22) + "...";
//                 };

//                 $("#history").children("." + update_class).children('#matter').text(update_text);
//             }

//             if (update_page != undefined) {

//                 $("#history").children("." + update_class).children('#other').text("Page: " + update_page);

//             }

//         };


//         function add_history(append_class, append_text, page_no, anno_type) {



//             var date = new Date();
//             var month = new Array();
//             month[0] = "Jan";
//             month[1] = "Feb";
//             month[2] = "Mar";
//             month[3] = "Apr";
//             month[4] = "May";
//             month[5] = "Jun";
//             month[6] = "Jul";
//             month[7] = "Aug";
//             month[8] = "Sep";
//             month[9] = "Oct";
//             month[10] = "Nov";
//             month[11] = "Dec";

//             var month_name = month[date.getMonth()];
//             var day = date.getDate();
//             var hour = date.getHours();
//             var minutes = date.getMinutes();

//             var time = "  " + month_name + " " + day + " " + hour + ":" + minutes;


//             var addHistoryObject = {
//                 append_class: append_class,
//                 append_text: append_text,
//                 page_no: page_no,
//                 anno_type: anno_type,
//                 time: time
//             };

//             sendChangeData(addHistoryObject, "add-history");


//             $("#history").append('<li class="' + append_class + '">' +
//                 '<div id="matter" style="padding-left:1px;margin-right:2px;white-space: nowrap; overflow: hidden;text-overflow: ellipsis;line-height:24px;float:left; top:0px;left: 40px;height:20px;width:95px;font-size: 10pt">' + escapeHtml(append_text) + '</div>' +
//                 '<div id="anno_type" style="text-align:right;color:#218221;opacity:0.6;font-size:8pt;line-height:23px;width:73px;height:20px;float:left"><b>' + anno_type + '</b></div>' +
//                 '<div id="other1" style="line-height:17px;float:left;color:#B2B2B2;top:20px;left:40px; height:15px;width:40px;font-size: 8pt">Page:' + page_no + ' </div>' +
//                 '<div id="other2" style="line-height:17px;float:left;color:#B2B2B2;top:20px;height:15px;width:65px;font-size:8pt">' + time + ' </div>' +
//                 '<div id="other3" style="line-height:17px;color:#B2B2B2;float:left;top:20px;height:15px;width:65px;font-size:8pt; overflow:hidden">' + user + '</div></li>');

//         };


//         function add_history_realtime(append_class, append_text, page_no, anno_type, time, name) {




//             $("#history").append('<li class="' + append_class + '">' +
//                 '<div id="matter" style="padding-left:1px;margin-right:2px;white-space: nowrap; overflow: hidden;text-overflow: ellipsis;line-height:24px;float:left; top:0px;left: 40px;height:20px;width:95px;font-size: 10pt">' + escapeHtml(append_text) + '</div>' +
//                 '<div id="anno_type" style="text-align:right;color:#218221;opacity:0.6;font-size:8pt;line-height:23px;width:73px;height:20px;float:left"><b>' + anno_type + '</b></div>' +
//                 '<div id="other1" style="line-height:17px;float:left;color:#B2B2B2;top:20px;left:40px; height:15px;width:40px;font-size: 8pt">Page:' + page_no + ' </div>' +
//                 '<div id="other2" style="line-height:17px;float:left;color:#B2B2B2;top:20px;height:15px;width:65px;font-size:8pt">' + time + ' </div>' +
//                 '<div id="other3" style="line-height:17px;color:#B2B2B2;float:left;top:20px;height:15px;width:65px;font-size:8pt; overflow:hidden">' + name + '</div></li>');

//         };



//         function isNumber(evt) {
//             evt = (evt) ? evt : window.event;
//             var charCode = (evt.which) ? evt.which : evt.keyCode;
//             if (charCode > 31 && (charCode < 48 || charCode > 57)) {
//                 return false;
//             }
//         }



//         function random_class_generator() {
//             function a() {
//                 return (((1 + Math.random()) * 65536) | 0).toString(16).substring(1);
//             }
//             return (a() + "-" + a() + "-" + a() + a() + a()).toLowerCase();
//         }

//         function random_comm_id_generator() {
//             function a() {
//                 return (((1 + Math.random()) * 65536) | 0).toString(16).substring(1);
//             }
//             return (a() + a() + "-" + a()).toLowerCase();
//         }


//         function svg_cont_style(cursor_type) {


//             /*  if( $("#comment-container").children().length > 0){ */

//             $('#svg-container').css({
//                 'position': 'absolute',
//                 'height': 'auto',
//                 'left': svg_left("after"),
//                 'cursor': cursor_type
//             });

//             /* } */

//             /* else if( $("#comment-container").children().length == 0){ */

//             /* $('#svg-container').css({'position':'absolute','height':'auto','left': svg_left("before"),'cursor':cursor_type}); */

//             /* } */


//         }

//         function connector_lines(y1, y2, conn_class) {

//             var xmlns = "http://www.w3.org/2000/svg";
//             var conn_elem = document.createElementNS(xmlns, "line");

//             /* 	elem.setAttributeNS(null,"style",recent_created_path.attr('style')); */


//             conn_elem.setAttributeNS(null, "x1", "0");
//             conn_elem.setAttributeNS(null, "y1", y1);
//             conn_elem.setAttributeNS(null, "x2", "27");
//             conn_elem.setAttributeNS(null, "y2", y2);
//             conn_elem.setAttributeNS(null, "style", "stroke:#99CCFF;stroke-width:1");
//             conn_elem.setAttributeNS(null, "class", conn_class);

//             document.getElementById('connector-svg').appendChild(conn_elem);


//         }

//         function comment_lines(x1, y1, x2, y2, rnd_class) {
//             var svg_width = $(".pf").width();

//             var xmlns = "http://www.w3.org/2000/svg";

//             var line_elem = document.createElementNS(xmlns, "line");

//             /* 	elem.setAttributeNS(null,"style",recent_created_path.attr('style')); */


//             line_elem.setAttributeNS(null, "x1", x1);
//             line_elem.setAttributeNS(null, "y1", y1);
//             line_elem.setAttributeNS(null, "x2", svg_width);
//             line_elem.setAttributeNS(null, "y2", y2);
//             line_elem.setAttributeNS(null, "style", "stroke:#99CCFF;stroke-width:1");
//             line_elem.setAttributeNS(null, "class", rnd_class);

//             document.getElementById('svg_id').appendChild(line_elem);


//         }


//         function delete_commentbox_update_arrays(del_object) {


//             if (del_object != undefined) {
//                 window.id_to_be_deleted = $(del_object).parent().attr('id');

//                 var col2 = all_click_y_positions.map(function(value, index) {
//                     return value[1];
//                 });




//                 for (j = 0; j < col2.length; j++) {

//                     if (col2[j] == id_to_be_deleted) {
//                         var index_to_be_deleted = j;

//                         break;
//                     };

//                 };

//                 if (index_to_be_deleted == undefined) {



//                 };


//                 /*   	var a = col2.indexOf("'"+id_to_be_deleted+"'");
//                  */

//                 var ind = $(del_object).parent().parent().children().index($(del_object).parent());


//                 $(del_object).parent().remove();
//                 original_aligned_y.splice(ind, 1);
//                 all_click_y_positions.splice(index_to_be_deleted, 1);


//                 if (ind > 0) {
//                     height_change_align_comment_boxes(ind - 1);
//                 } else if (ind == 0 && $("#comment-container").children().length > 0) { /* no re-alignment needed after last comment box is deleted   */
//                     var zeroeth_elem_orig_top = original_aligned_y[0];


//                     $("#comment-container ul:first-child").css('top', new_top_calculator(zeroeth_elem_orig_top));
//                     height_change_align_comment_boxes(0);
//                     $("#connector-svg > ." + $("#comment-container ul:first-child").attr('class').split(' ')[1]).attr("y2", new_top_calculator(zeroeth_elem_orig_top));
//                 }
//             } /* for.... if(del_object != undefined) */
//             else {}

//         }


//         function contextmenu_activate() {

//             $(function() {
//                 $.contextMenu({

//                     selector: '.highlighted',
//                     build: function(selector, e) {
//                         if ($(selector[0]).parent().attr('class').split(' ')[0] == 'striked') {

//                             return {
//                                 callback: function(key, options) {

//                                     switch (key) {
//                                         case "remove-highlight":

//                                             var elem = "." + $(this).attr('class').split(' ')[1];

//                                             $('#svg-container').getHighlighter().removeHighlights("." + $(this).attr('class').split(' ')[1], $(this).attr('class').split(' ')[1]);

//                                             /* var elem = "$('#comment-container > ."+$(this).attr('class').split(' ')[1] + "')";
//                                              */

//                                             removeCommentUl($(this).attr('class').split(' ')[1]);



//                                             sendChangeData($(this).attr('class').split(' ')[1], "remove-highlight");


//                                             $("#svg_id > " + elem).remove();
//                                             $("#connector-svg > " + elem).remove();
//                                             $("#history > " + elem).remove();
//                                             delete_commentbox_update_arrays($(elem).children('.delete-comment')[0]);
//                                             if ($("#comment-container").children().length == 0) {
//                                                 /* $('#svg-container').css({'position':'absolute','height':'auto','left': svg_left("before")}); */
//                                                 comm_del = 0;
//                                                 /* When last comment-box is deleted, page should shift*/
//                                                 /* Currently hardcoded, should vary acc to page width*/
//                                             }

//                                             /*  delete_commentbox_update_arrays($(this).attr('class').split(' ')[1]); */
//                                             //sendChangeData(,"remove-highlight")

//                                             break;
//                                         case "remove-strike":
//                                             var str = "." + $(this).parent().attr('class').split(' ')[1];
//                                             $('#svg-container').getHighlighter().removeHighlights("." + $(this).parent().attr('class').split(' ')[1], $(this).parent().attr('class').split(' ')[1]);

//                                             $("#history > " + str).remove();

//                                             sendChangeData($(this).parent().attr('class').split(' ')[1], "remove-strikeout");

//                                             break;
//                                     }
//                                 },
//                                 items: {
//                                     "remove-highlight": {
//                                         name: "Remove Highlight",
//                                         icon: "delete"
//                                     },
//                                     "remove-strike": {
//                                         name: "Remove Strike",
//                                         icon: "delete"
//                                     },
//                                 }
//                             };
//                         } else {
//                             return {
//                                 callback: function(key, options) {
//                                     var elem = "." + $(this).attr('class').split(' ')[1];
//                                     $('#svg-container').getHighlighter().removeHighlights("." + $(this).attr('class').split(' ')[1], $(this).attr('class').split(' ')[1]);

//                                     // Vipul Sodha ~ to send Changed data ! Currently sending serialized highlights
//                                     sendChangeData($(this).attr('class').split(' ')[1], "remove-highlight");

//                                     removeCommentUl($(this).attr('class').split(' ')[1]);


//                                     $(elem).remove();

//                                     delete_commentbox_update_arrays($(elem).children('.delete-comment')[0]);

//                                     if ($("#comment-container").children().length == 0) {
//                                         /* $('#svg-container').css({'position':'absolute','height':'auto','left': svg_left("before")}); */
//                                         comm_del = 0;
//                                         /* When last comment-box is deleted, page should shift*/
//                                         /* Currently hardcoded, should vary acc to page width*/
//                                     }
//                                 },
//                                 items: {
//                                     "remove-highlight": {
//                                         name: "Remove Highlight",
//                                         icon: "delete"
//                                     },
//                                 }
//                             };
//                         }
//                     }
//                 });
//             });


//             $(function() {
//                 $.contextMenu({

//                     selector: '.striked',
//                     build: function(selector, e) {
//                         if ($(selector[0]).parent().attr('class').split(' ')[0] == 'highlighted') {

//                             return {
//                                 callback: function(key, options) {

//                                     switch (key) {
//                                         case "remove-strike":
//                                             var str = "." + $(this).attr('class').split(' ')[1];


//                                             sendChangeData($(this).attr('class').split(' ')[1], "remove-strikeout");



//                                             $('#svg-container').getHighlighter().removeHighlights("." + $(this).attr('class').split(' ')[1], $(this).attr('class').split(' ')[1]);
//                                             $("#history > " + str).remove();


//                                             break;
//                                         case "remove-highlight":
//                                             var elem = "." + $(this).parent().attr('class').split(' ')[1];

//                                             sendChangeData($(this).parent().attr('class').split(' ')[1], "remove-highlight");

//                                             removeCommentUl($(this).parent().attr('class').split(' ')[1]);


//                                             $('#svg-container').getHighlighter().removeHighlights("." + $(this).parent().attr('class').split(' ')[1], $(this).parent().attr('class').split(' ')[1]);
//                                             $("#svg_id > " + elem).remove();
//                                             $("#connector-svg > " + elem).remove();
//                                             $("#history > " + elem).remove();


//                                             delete_commentbox_update_arrays($(elem).children('.new-comment')[0]);
//                                             if ($("#comment-container").children().length == 0) {
//                                                 /* $('#svg-container').css({'position':'absolute','height':'auto','left': svg_left("before")}); */
//                                                 comm_del = 0;
//                                                 /* When last comment-box is deleted, page should shift*/
//                                                 /* Currently hardcoded, should vary acc to page width*/
//                                             }
//                                             break;
//                                     }
//                                 },
//                                 items: {
//                                     "remove-highlight": {
//                                         name: "Remove Highlight",
//                                         icon: "delete"
//                                     },
//                                     "remove-strike": {
//                                         name: "Remove Strike",
//                                         icon: "delete"
//                                     },
//                                 }
//                             };
//                         } else {
//                             return {
//                                 callback: function(key, options) {
//                                     var str = "." + $(this).attr('class').split(' ')[1];
//                                     $('#svg-container').getHighlighter().removeHighlights("." + $(this).attr('class').split(' ')[1], $(this).attr('class').split(' ')[1]);
//                                     $("#history > " + str).remove();

//                                     sendChangeData($(this).attr('class').split(' ')[1], "remove-strikeout");

//                                 },
//                                 items: {
//                                     "remove-strike": {
//                                         name: "Remove Strike",
//                                         icon: "delete"
//                                     },
//                                 }
//                             };
//                         }
//                     }
//                 });
//             });

//         }




//         function draw_contextmenu() {


//             $(function() {
//                 $.contextMenu({

//                     selector: '.pathclass',
//                     callback: function() {

//                         var path_elem = $(this).attr('class').split(' ')[1]
//                         $("#svg_id ." + path_elem).remove();
//                         $("#history > ." + path_elem).remove();
//                         var removeDraw = {
//                             pathClass: path_elem
//                         };
//                         sendChangeData(removeDraw, "remove-draw");
//                     },
//                     items: {
//                         "remove-draw": {
//                             name: "Remove Path",
//                             icon: "delete"
//                         }

//                     }

//                 });
//             });

//         }



//         function svg_left(state) {


//             var page_cont_width = $("#page-container").width();
//             var svg_width = $(".pf").width();

//             if (state == "before") {

//                 return ((page_cont_width - 17 - svg_width) / 2) + "px";
//             } else if (state == "after") {

//                 return 15 + "px";   // we have decided to keep this
//             }
//         }


//         function svg_left_no_px(state) {

//             var page_cont_width = $("#page-container").width();
//             var svg_width = $(".pf").width();

//             if (state == "before") {

//                 return ((page_cont_width - 17 - svg_width) / 2);
//             } else if (state == "after") {

//                 return 15;  // we have decided to keep this
//             }

//         }


//         function change_sketchpads(flag) {

//             if (flag == 1 && draw_state == 0) {

//                 document.getElementById("svg_id").style.pointerEvents = "visiblepainted";
//                 sketchpad.editing(true);
//                 /* (eval("sketchpad")).editing(true); */

//             } else if (flag == 0 && draw_state == 1) {

//                 sketchpad.editing(false);
//                 /* (eval("sketchpad")).editing(false); */
//                 document.getElementById("svg_id").style.pointerEvents = "none";

//                 draw_state = 0;

//             } else {}
//         }

//         function change_draw_color(color) {

//             sketchpad.pen().color(color);
//             /* (eval("sketchpad")).pen().color(color); */

//         }



//         $(document).on({

//             click: function() {

//                 $("#page-container").scrollTo("#svg-container ." + $(this).attr('class'), 0, {
//                     offset: -25
//                 });
//                 $(".tool").prop("checked", false);

//                 switch ($('.' + $(this).attr('class') + ' > #anno_type > b')[0].innerHTML) {

//                     case "Strike":
//                         $("#strike").prop("checked", true);
//                         check_value("strike");
//                         break;

//                     case "Highlight":
//                         $("#highlight").prop("checked", true);
//                         check_value("highlight");
//                         break;

//                     case "Draw":
//                         $("#draw").prop("checked", true);
//                         check_value("draw");
//                         break;

//                     case "Text box":
//                         $("#textbox").prop("checked", true);
//                         check_value("textbox");
//                         break;

//                     case "Pin comment":
//                         $("#drop-comment").prop("checked", true);
//                         check_value("drop-comment");
//                         break;

//                     case "Text comment":
//                         $("#drag-comment").prop("checked", true);
//                         check_value("drag-comment");
//                         break;




//                 }

//                 ;


//             }
//         }, '#history > li');


//         $(document).on({
  
  
  
//             mouseover: function() {

//                 if ($('#draw').is(':checked') == true) {
//                     $(this).css({
//                         "cursor": "url(../images/right-click.cur),default"
//                     });
//                 } else {

//                     $(this).css({
//                         "cursor": "url(../images/textbox.cur),default"
//                     });
//                 }

//             }
//         }, '.pathclass');




//         $(document).on({

//             keyup: function() {

//                 if ($(this).val() != "") {

//                     $(this).parent().siblings('.submit-comment').addClass('submit-active').removeClass('submit-inactive');

//                 } else {

//                     $(this).parent().siblings('.submit-comment').addClass('submit-inactive').removeClass('submit-active');

//                 }

//             }
//         }, '.active-comment');



//         $(document).on({

//             click: function() {

// alert("dead twice");

            

//     console.log($(this).parent().children("li:last").children(".active-comment").val());

//                 var new_elem_content = escapeHtml($(this).parent().children("li:last").children(".active-comment").val()).replace(/\r\n|\r|\n/g, "<br />");
//                 $(this).parent().children("li:last").append("<div class='comment-text' contenteditable='false'>" + new_elem_content + "</div>");


//                 $(this).parent().find(".active-comment").remove();


//                 var par_class = $(this).parent().attr('class').split(' ')[1];
//                 dropCommentObject = {
//                     elemId: $(this).parent().attr("id"),
//                     newLiId: $(this).parent().children("li:last").attr('id'),
//                     uniqueClass: par_class,
//                     content: $(this).parent().children("li:last").children(".comment-text").html()
//                 };



//                 if ($("." + par_class + " li").length == 1) {
//                     //first comment in box



//                     var position = $("#image-container > ." + par_class).position();

//                     dropCommentObject.cords = commentBoxCords[par_class];
//                     // console.log(commentBoxCords);

//                     if (commentBoxCords[par_class].type === 'drag') {
//                         dropCommentObject.serializeData = dropCommentObject.cords.highlight;
//                         delete dropCommentObject.cords.highlight;

//                     }

//                     alert("one");




//                     sendChangeData(dropCommentObject, "new-drop-comment");

//                 } else {
//                     alert("two");
//                     //console.log( $("#"+ dropCommentObject.newLiId).prev().attr('id'));
//                     dropCommentObject.afterLiId = $("#" + dropCommentObject.newLiId).prev().attr('id');
//                     dropCommentObject.cords = commentBoxCords[par_class];
//                     //console.log(dropCommentObject);
//                     sendChangeData(dropCommentObject, "update-drop-comment");
//                 }
//                 // console.log(commentBoxCords);

//     $(this).siblings('.new-comment').addClass('new-comm-active').removeClass('new-comm-inactive');
//                 $(this).addClass('submit-inactive').removeClass('submit-active');

//             }
//         }, '.submit-active');

//         $(document).on({

//             click: function() {
//                 var rnd_comm_id = random_comm_id_generator();

//                 $(this).addClass('new-comm-inactive').removeClass('new-comm-active');

//                 $(this).before('<li id = ' + rnd_comm_id + '><span class="critic_name" contenteditable="false">' + user + ':</span><span class="trash-comment"><img src="../images/trash.png"></span><textarea class="active-comment autoExpand" rows="3" data-min-rows="3" spellcheck="false" autofocus></textarea></li>');

//                 $("#" + rnd_comm_id).find('textarea').focus();
//                 // console.log($("#"+rnd_comm_id).find('textarea'));
//                 //$("#"+rnd_comm_id+" .comment-text").click();

//             }
//         }, '.new-comm-active');


//         $(document).on({

//             click: function() {

//                 $(this).parent().siblings('.submit-comment').addClass('submit-inactive').removeClass('submit-active');
//                 $(this).parent().siblings('.new-comment').addClass('new-comm-active').removeClass('new-comm-inactive');

//             }
//         }, '.comment-box span.trash-comment:last');


//         $(document).on({

//             click: function() {

//                 var del_class = "." + $(this).closest(".comment-box").attr('class').split(' ')[1];

//                 dropCommentObject = {
//                     delLiId: $(this).parent().attr('id'),
//                     uniqueClass: $(this).parent().parent().attr('class').split(' ')[1]

//                 };

//                 dropCommentObject.type = commentBoxCords[dropCommentObject.uniqueClass].type;
//                 sendChangeData(dropCommentObject, "delete-drop-comment");



//                 if ($(del_class + " li").length == 1) {


//                     if ($('#strike').is(':checked') == true || $('#highlight').is(':checked') == true || $('#drag-comment').is(':checked') == true) {


//                         $('#svg-container').getHighlighter().removeHighlights("." + $(this).closest(".comment-box").attr('class').split(' ')[1], $(this).closest(".comment-box").attr('class').split(' ')[1]);
//                         $("#svg_id > " + del_class).remove();
//                         $("#connector-svg > " + del_class).remove();
//                         $("#image-container > " + del_class).remove();
//                         $("#history > " + del_class).remove();
//                         delete_commentbox_update_arrays($(this).parent());

//                     } else {

//                         $('#svg-container').textHighlighter();
//                         $('#svg-container').getHighlighter().removeHighlights("." + $(this).closest(".comment-box").attr('class').split(' ')[1], $(this).closest(".comment-box").attr('class').split(' ')[1]);

//                         $("#svg_id > " + del_class).remove();
//                         $("#connector-svg > " + del_class).remove();
//                         $("#image-container > " + del_class).remove();
//                         $("#history > " + del_class).remove();
//                         delete_commentbox_update_arrays($(this).parent());
//                         $('#svg-container').getHighlighter().destroy();

//                     }



//                 } else {




//                     $(this).parent().remove();

//                 }

//                 if ($("#comment-container").children().length == 0) {

//                     comm_del = 0;
//                 }



//             }
//         }, '.trash-comment');




//         $(document).on({

//             mouseenter: function(e) {

//                 e.stopPropagation();
//                 var rgb_str = $(this).css("background-color");
//                 var rgba_str = "rgba(" + rgb_str.substring(rgb_str.lastIndexOf('(') + 1, rgb_str.lastIndexOf(')')) + ", 0.6)";


//                 if ($('#strike').is(':checked') == true || $('#highlight').is(':checked') == true || $('#drag-comment').is(':checked') == true) {

//                     $('#svg-container span.' + $(this).attr('class').split(' ')[1]).css("background-color", rgba_str); /* '#abc .xyz' searches for xyz class within entire abc  */

//                     $('#comment-container .' + $(this).attr('class').split(' ')[1]).css("border-color", "rgba(255,255,255,0.5)");
//                     $('#svg_id > .' + $(this).attr('class').split(' ')[1]).css("stroke", "rgba(127,255,255,0.4)");
//                     $('#connector-svg > .' + $(this).attr('class').split(' ')[1]).css("stroke", "rgba(127,255,255,0.4)");

//                 } else {

//                 }

//             },
//             mouseleave: function(e) {
//                 e.stopPropagation();
//                 var rgb_str = $(this).css("background-color");
//                 var rgba_str = "rgba(" + rgb_str.substring(rgb_str.lastIndexOf("(") + 1, rgb_str.lastIndexOf(",")) + ",1)";

//                 if ($('#strike').is(':checked') == true || $('#highlight').is(':checked') == true || $('#drag-comment').is(':checked') == true) {

//                     $('#svg-container span.' + $(this).attr('class').split(' ')[1]).css("background-color", rgba_str);
//                     $('#comment-container .' + $(this).attr('class').split(' ')[1]).css("border-color", "rgba(255,255,255,1)");

//                     $('#svg_id > .' + $(this).attr('class').split(' ')[1]).css("stroke", "#99CCFF");
//                     $('#connector-svg > .' + $(this).attr('class').split(' ')[1]).css("stroke", "#99CCFF");
//                 } else {

//                     /*not to be run for any checks other than drag, highlight, strike  */
//                 }

//             }

//         }, '.highlighted');



//         $(document).on({

//             mouseenter: function(e) {

//                 e.stopPropagation();
//                 var rgb_str = $("#svg-container ." + $(this).attr('class').split(' ')[1]).css("background-color");
//                 var rgba_str = "rgba(" + rgb_str.substring(rgb_str.lastIndexOf("(") + 1, rgb_str.lastIndexOf(")")) + ", 0.6)";

//                 $('#svg-container span.' + $(this).attr('class').split(' ')[1]).css("background-color", rgba_str); /* '#abc .xyz' searches for xyz class within entire abc  */

//                 $(this).css("border-color", "rgba(255,255,255,0.5)");
//                 $('#svg_id > .' + $(this).attr('class').split(' ')[1]).css("stroke", "rgba(127,255,255,0.4)");
//                 $('#connector-svg > .' + $(this).attr('class').split(' ')[1]).css("stroke", "rgba(127,255,255,0.4)");

//             },
//             mouseleave: function(e) {
//                 e.stopPropagation();
//                 var rgb_str = $("#svg-container ." + $(this).attr('class').split(' ')[1]).css("background-color");
//                 var rgba_str = "rgba(" + rgb_str.substring(rgb_str.lastIndexOf("(") + 1, rgb_str.lastIndexOf(",")) + ",1)";

//                 $('#svg-container span.' + $(this).attr('class').split(' ')[1]).css("background-color", rgba_str);
//                 $(this).css("border-color", "rgba(255,255,255,1)");

//                 $('#svg_id > .' + $(this).attr('class').split(' ')[1]).css("stroke", "#99CCFF");
//                 $('#connector-svg > .' + $(this).attr('class').split(' ')[1]).css("stroke", "#99CCFF");
//             }

//         }, '.comment-box');


//         $(document)
//             .on('focus.textarea', '.autoExpand', function() {
//                 var savedValue = this.value;
//                 this.value = '';
//                 this.baseScrollHeight = this.scrollHeight;
//                 this.value = savedValue;
//             })
//             .on('input.textarea', '.autoExpand', function() {
//                 var minRows = this.getAttribute('data-min-rows') | 0,
//                     rows;
//                 this.rows = minRows;
//                 rows = Math.ceil((this.scrollHeight - this.baseScrollHeight) / 16);
//                 this.rows = minRows + rows;
//             });

//         function remove_textbox_styles(cursor_style) {


//             $(document).off("mouseenter mouseleave mouseup mousedown click mouseover", ".handle");
//             $(document).off("mouseenter mouseleave click ", ".box");
//             $(document).off("mouseenter mouseleave click mouseover", ".delete-text-box");
//             $('.handle').find(".delete-text-box").css({
//                 "opacity": "0"
//             });
//             $('.handle').css('outline', 'none');
//             $('.handle').css('cursor', function() {
//                 return cursor_style;
//             });
//             $('.handle').draggable();
//             $('.handle').draggable('disable');
//             $('.box').attr('contenteditable', 'false');
//             $('.handle').addClass('unselectable');

//         }


//         function textbox_events() {


//             svg_cont_style("url(../images/textbox.cur),default");

//             $('.box').attr('contenteditable', 'true');
//             $('.handle').removeClass('unselectable');

//             $(document).on({

//                 mouseenter: function() {

//                     $(this).css('outline', '1px solid #33CCFF');
//                     //$(this).find(".box").css('outline','none');
//                     $(this).find(".delete-text-box").css({
//                         "opacity": "0.4"
//                     });
//                 },
//                 mouseleave: function() {

//                     //$(this).css('outline','none');
//                     $(this).find(".delete-text-box").css({
//                         "opacity": "0"
//                     });
//                     if ($(this).find(".box").is(':focus') == false) {
//                         $(this).css('outline', 'none');
//                     }
//                 },
//                 click: function() {
//                     //don't do anything as click on handle shouldn't
//                 },
//                 mousedown: function() {

//                     $(this).css('cursor', 'url(../images/closedhand.cur),auto');

//                 },
//                 mouseup: function() {

//                     $(this).css('cursor', 'url(../images/openhand.cur),auto');
//                 },
//                 mouseover: function() {
//                     $(this).css('cursor', 'url(../images/openhand.cur),auto');
//                     $(this).draggable({
//                         containment: 'parent',
//                         stop: function() {

//                             var offset = $(this).offset();
//                             var xPos = offset.left;
//                             var yPos = offset.top - $("#svg-container").offset().top;
//                             var page_no = (Math.ceil(yPos / (page_height + 13)) > cnt ? cnt : Math.ceil(yPos / (page_height + 13)));

//                             update_history($(this).attr('class').split(' ')[2], undefined, page_no);
//                             var position = $(this).position();

//                             textBoxObject = {
//                                 x: position.left,
//                                 y: position.top,
//                                 uniqueClass: $(this).attr('class').split(' ')[2]
//                             };
//                             sendChangeData(textBoxObject, "textbox-position-update");

//                         }
//                     });
//                 }
//             }, '.handle');


//             $(document).on({

//                 mouseenter: function(event) {

//                     $(this).css({
//                         "opacity": "1"
//                     });
//                     //$(this).css({"opacity":"1","background-size":"16px 16px"});
//                     $(this).siblings(".box").css({
//                         "opacity": "0.3"
//                     });
//                     $(this).parent().css('outline', '1px solid #33CCFF');
//                     event.stopPropagation();
//                 },
//                 mouseleave: function() {
//                     //$(this).css({"opacity":"0.4","background-size":"12px 12px"});

//                     $(this).css({
//                         "opacity": "0.4"
//                     });
//                     $(this).siblings(".box").css({
//                         "opacity": "1"
//                     });
//                 },
//                 mouseover: function() {

//                     $(this).css({
//                         "cursor": "pointer"
//                     });
//                 },
//                 click: function(event) {
//                     event.stopPropagation();
//                     if ($.trim($('#svg-container div.box:last').text()).length === 0) {

//                         $('#svg-container div.box:last').parent().remove();
//                         fcs = 0;
//                         textBoxObject = {
//                             uniqueClass: $(this).parent().attr('class').split(' ')[2]
//                         };
//                         sendChangeData(textBoxObject, "delete-textbox");

//                     } else {}

//                     fcs = 0;
//                     $("#history > ." + $(this).parent().attr('class').split(' ')[2]).remove();
//                     $(this).parent().remove();



//                 }

//             }, '.delete-text-box');

//             // $(document).on({

//             //     mouseenter: function() {
//             //         $(this).css('cursor', 'text');
//             //         $(this).parent().draggable('disable');
//             //         //	$(this).css('outline','1px dotted #6f6f77');
//             //         //	$(this).parent().css('outline','none');

//             //     },
//             //     mouseleave: function() {
//             //         $(this).parent().draggable('enable');
//             //     },
//             //     click: function() {
//             //         $('.handle').css('outline', 'none');
//             //         $(this).parent().css('outline', '1px solid #33CCFF');
//             //         $('.delete-text-box').css('opacity', '0');

//             //         $(this).siblings(".delete-text-box").css('opacity', '0.4');
//             //     }

//             // }, '.box');


//         }

//         function call_handle_jquery() {
//             $('.handle').css('outline', 'none');
//             $('.delete-text-box').css('opacity', '0');



//             $(".handle").draggable({
//                 containment: 'parent'
//             });

//             $('.handle').mouseenter(function() {

//                 $(this).css('outline', '1px solid #33CCFF');
//                 //$(this).find(".box").css('outline','none');
//                 $(this).find(".delete-text-box").css({
//                     "opacity": "0.4"
//                 });
//             });

//             $('.handle').mouseleave(function() {

//                 //$(this).css('outline','none');
//                 $(this).find(".delete-text-box").css({
//                     "opacity": "0"
//                 });
//                 if ($(this).find(".box").is(':focus') == false) {
//                     $(this).css('outline', 'none');
//                 }

//             });

//             $('.delete-text-box').mouseenter(function() {

//                 event.stopPropagation();
//                 $(this).css({
//                     "opacity": "1"
//                 });
//                 //$(this).css({"opacity":"1","background-size":"16px 16px"});
//                 $(this).siblings(".box").css({
//                     "opacity": "0.3"
//                 });
//                 $(this).parent().css('outline', '1px solid #33CCFF');
//             });

//             $('.delete-text-box').mouseleave(function() {
//                 //$(this).css({"opacity":"0.4","background-size":"12px 12px"});

//                 $(this).css({
//                     "opacity": "0.4"
//                 });
//                 $(this).siblings(".box").css({
//                     "opacity": "1"
//                 });
//             });

//             $('.box').mouseenter(function() {
//                 $(this).css('cursor', 'text');
//                 $(this).parent().draggable('disable');
//                 //	$(this).css('outline','1px dotted #6f6f77');
//                 //	$(this).parent().css('outline','none');

//             });

//             $('.box').mouseleave(function() {
//                 $(this).parent().draggable('enable');

//             });

//             $('.box').click(function() {
//                 $('.handle').css('outline', 'none');
//                 $(this).parent().css('outline', '1px solid #33CCFF');
//                 $('.delete-text-box').css('opacity', '0');

//                 $(this).siblings(".delete-text-box").css('opacity', '0.4');
//             });

//             $('.handle').click(function() {
//                 //Dont do anything as clicked on handle

//             });

//             $('.delete-text-box').click(function() {
//                 event.stopPropagation();


//                 if ($.trim($('#svg-container div.box:last').text()).length === 0) {


//                     $('#svg-container div.box:last').parent().remove();
//                     fcs = 0;
//                 } else {}

//                 fcs = 0;
//                 $(this).parent().remove();
//                 /* $(this).siblings(".box").remove(); */

//             });
//         }


//         function check_value(check_id) { //sends the id of the checked button

//             if (document.getElementById(check_id).checked) { //will case the button which is checked 

//                 switch (check_id) {

//                     case "textbox":



//                         $('#svg-container').textHighlighter();
//                         $('#svg-container').getHighlighter().destroy();
//                         $('#svg-container').unbind(); //to unbind click for comment
//                         $.contextMenu('destroy');
//                         //  call_handle_jquery();


//                         window.focussed_class = "";
//                         window.fcs = 0;
//                         $('.clickable')
//                             .bind(
//                                 'click',
//                                 function(ev) {

//                                     var page_no_textbox = (Math.ceil((ev.clientY - $(".clickable").offset().top) / ($('.pf').height() + 13)) > cnt ? cnt : Math.ceil((ev.clientY - $(".clickable").offset().top) / ($('.pf').height() + 13)));

//                                     if ($(".box").length > 0) { // If the no of .box > 0 only then the below condition needs to be checked   

//                                         if ($.trim($('#svg-container div.box:last').text()).length === 0) {

//                                             $("#history  li." + $('#svg-container div.handle:last').attr('class').split(' ')[2]).remove();

//                                             $('#svg-container div.box:last').parent().remove();

//                                             fcs = 0;
//                                         } else {

//                                         }
//                                     }

//                                     if ($(".box").is(':focus') == false && fcs != 1) {
//                                         var $div = $(ev.target);


//                                         var offset = $div.offset();
//                                         var x = ev.clientX - offset.left;
//                                         var y = ev.clientY - offset.top;

//                                         $('.handle').css('outline', 'none');

//                                         textBoxObject.x = x;
//                                         textBoxObject.y = y;

//                                         //console.log("called X Y" + x);


//                                         var rnd_class = random_class_generator();

//                                         // constructTextBox(rnd_class, x, y, "", true);
//                                         $("#svg-container")
//                                             .append(
//                                                 '<div class="handle bar ' + rnd_class + '"' + ' style="margin:8px;z-index:3;cursor:url(../images/openhand.cur) 7.5 7.5,default;height:auto; width:auto;overflow:visible;outline: 1px solid #33CCFF;color:red;text-shadow: -1px -1px 0 #FFF, 1px -1px 0 #FFF, -1px 1px 0 #FFF, 1px 1px 0 #FFF;' + 'position:absolute;padding:6px;background:transparent;top:' + y + 'px;left:' + x + 'px">'
//                                                 //cursor has 'default' .. don't know        what it means

//                                                 + '<div class="box lim" ' + 'style="vertical-align:baseline;background:transparent;float:left;border:1px;solid;padding:1px;outline:none"' + ' contenteditable="true" spellcheck="false">' + '</div>'

//                                                 + '<div class="delete-text-box" style="position:absolute;top:-9px;right:-9px;float:right;background-image:url(../images/delete16x16.png);background-repeat:no-repeat;background-position:center center;' + 'border: none;cursor: default;height: 16px;width: 16px;outline: none;opacity:0.4"></div>'

//                                                 + '</div>');
//                                         $(".box").focus();

//                                         fcs = 1;


//                                     } else {

//                                         if ($(".box").is(':focus') == true) {
//                                             fcs = 1;





//                                             if (focussed_class != "") {
//                                                 if ($.trim($("#svg-container ." + focussed_class).text()).length == 0) {

//                                                     $("#history  li." + focussed_class).remove();
//                                                     $("#svg-container ." + focussed_class).remove();

//                                                 } else {

//                                                     //console.log(focussed_class);

//                                                     update_history(focussed_class, $("#svg-container ." + focussed_class + " > .box").text());

//                                                     var text = $("." + focussed_class + " > .box").html();
//                                                     //console.log(text);
//                                                     textBoxObject.uniqueClass = focussed_class;
//                                                     textBoxObject.content = text;
//                                                     //console.log(focussed_class);

//                                                     //console.log("update Called 1");
//                                                     sendChangeData(textBoxObject, "textbox-update");

//                                                     // console.log(textBoxObject);
//                                                 }

//                                             }



//                                             focussed_class = document.activeElement.parentElement.getAttribute('class').split(' ')[2];
//                                             // console.log(focussed_class);
//                                             var last_class = $('#svg-container div.handle:last').attr('class').split(' ')[2];

//                                             if ($("#history > li." + last_class).length == 0) {
//                                                 add_history(last_class, $("." + last_class).text(), page_no_textbox, "Text box");

//                                                 var text = $("." + last_class + " > .box").text();

//                                                 textBoxObject.content = text;
//                                                 textBoxObject.uniqueClass = last_class;

//                                                 //box - > old box
//                                                 console.log("add called 1 : Box-> old Box");
//                                                 sendChangeData(textBoxObject, "textbox-new");
//                                             }


//                                         } else {

//                                             //clicked outside a textbox when one has focus

//                                             fcs = 0;
//                                             $(".handle").css('outline', 'none');
//                                             $(".delete-text-box").css('opacity', '0');

//                                             var last_class = $('#svg-container div.handle:last').attr('class').split(' ')[2];

//                                             if ($("#history > li." + last_class).length == 0) {
//                                                 add_history(last_class, $("." + last_class).text(), page_no_textbox, "Text box");


//                                                 //new box one focus out on page
//                                                 var text = $("." + last_class + " > .box").html();

//                                                 textBoxObject.content = text;
//                                                 textBoxObject.uniqueClass = last_class;


//                                                 // Box -> window
//                                                 //console.log("add called 2 Box-> Window");
//                                                 sendChangeData(textBoxObject, "textbox-new");

//                                             } else {


//                                                 if ($.trim($("#svg-container ." + focussed_class).text()).length === 0) {

//                                                     $("#history  li." + focussed_class).remove();
//                                                     $("#svg-container ." + focussed_class).remove();

//                                                 } else {
//                                                     update_history(focussed_class, $("#svg-container ." + focussed_class + " > .box").text());
//                                                     // update just the string as the history ref is also present

//                                                     //UPDATE TEXT BOX 
//                                                     var text = $("#svg-container ." + focussed_class + " > .box").html();
//                                                     //console.log(text);

//                                                     textBoxObject.uniqueClass = focussed_class;
//                                                     textBoxObject.content = text;

//                                                     //console.log("update called 2 !  Edit -> window");
//                                                     sendChangeData(textBoxObject, "textbox-update");
//                                                 }
//                                             }

//                                         }
//                                     };

//                                 });

//                         $('#svg-container').textHighlighter();
//                         $('#svg-container').getHighlighter().destroy();
//                         $('.highlight_colors').css('display', 'none');
//                         $('.draw_colors').css('display', 'none');

//                         $("#draw, #strike, #highlight, #drop-comment,#drag-comment, #highlight_blue, #highlight_red, #highlight_green, #highlight_yellow, #draw_black, #draw_red, #draw_green, #draw_blue").prop('checked', false);


//                         change_sketchpads(0);
//                         document.getElementById("svg_id").style.pointerEvents = "visiblepainted";
//                         textbox_events();

//                         break;

//                     case "highlight":

//                         remove_textbox_styles("");

//                         $('#svg-container').textHighlighter();
//                         $('#svg-container').getHighlighter().destroy();
//                         $("#draw, #strike,#textbox, #drop-comment,#drag-comment, #highlight_blue, #highlight_green, #highlight_yellow, #draw_black, #draw_red, #draw_green, #draw_blue").prop('checked', false);
//                         document.getElementById("highlight_red").checked = true; // Because default is red here


//                         $('.highlight_colors').css('display', 'block');
//                         $('.draw_colors').css('display', 'none');
//                         change_sketchpads(0);
//                         document.getElementById("svg_id").style.pointerEvents = "none";
//                         $('.clickable').unbind();

//                         svg_cont_style("url(../images/red.cur),default");


//                         /*               $("#svg-container").css({"cursor":"url(../../images/red.cur),default"}); */
//                         $('#svg-container').textHighlighter({

//                             onAfterHighlight: function(highlights, range) {
//                                 var json_str = high.serializeHighlights();

//                                 var par_class = $(highlights[0]).attr('class').split(' ')[1];

//                                 json_str = highlightedSeries(json_str, par_class);

//                                 var highlightObject = {
//                                     serializeData: json_str,
//                                     uniqueClass: par_class
//                                 };
//                                 sendChangeData(highlightObject, "highlight");



//                                 add_history(par_class, range, $($(highlights[0]).closest(".pf")[0]).index() + 1, "Highlight");
//                                 //console.log(high);
//                             }

//                         });

//                         high = $('#svg-container').getHighlighter();
//                         //var json_str = high.serializeHighlights();
//                         // console.log(json_str);
//                         high.setStrike('');
//                         // console.log(high);
//                         $('#svg-container').getHighlighter().setColor('#ee7d7d');
//                         contextmenu_activate();

//                         break;

//                     case "strike":

//                         remove_textbox_styles("text");

//                         /* $("#svg-container").css({"cursor": "text"}); */
//                         $('#svg-container').textHighlighter();
//                         $('#svg-container').getHighlighter().destroy();

//                         $("#draw, #textbox, #highlight, #drop-comment,#drag-comment, #highlight_blue, #highlight_red, #highlight_green, #highlight_yellow, #draw_black, #draw_red, #draw_green, #draw_blue").prop('checked', false);

//                         $('.highlight_colors').css('display', 'none');
//                         $('.draw_colors').css('display', 'none');

//                         change_sketchpads(0);
//                         svg_cont_style("url(../images/strike.cur),default");


//                         document.getElementById("svg_id").style.pointerEvents = "none";
//                         $('.clickable').unbind();

//                         $('#svg-container').textHighlighter({

//                             onAfterHighlight: function(highlights, range) {

//                                 var json_str = strike.serializeStriked();
//                                 // Vipul Sodha ~ to send Changed data ! Currently sending serialized highlights
//                                 var par_class = $(highlights[0]).attr('class').split(' ')[1];
//                                 json_str = highlightedSeries(json_str, par_class);

//                                 var strikeObject = {
//                                     serializeData: json_str,
//                                     uniqueClass: par_class
//                                 };
//                                 sendChangeData(strikeObject, "strikeout");

//                                 add_history($(highlights[0]).attr('class').split(' ')[1], range, $($(highlights[0]).closest(".pf")[0]).index() + 1, "Strike");

//                             }

//                         });


//                         var strike = $('#svg-container').getHighlighter();
//                         strike.setStrike('line-through');
//                         contextmenu_activate();
//                         break;

//                     case "highlight_red":

//                         $("#highlight_blue, #highlight_green, #highlight_yellow,").prop('checked', false);
//                         $('#svg-container').css({
//                             "cursor": "url(../images/red.cur),default"
//                         });
//                         /* document.getElementById("strike").checked = false;
//                          document.getElementById("highlight_blue").checked = false;
//                          document.getElementById("highlight_green").checked = false;
//                          document.getElementById("highlight_yellow").checked = false;
//                          document.getElementById("draw").checked = false;
//                          document.getElementById("textbox").checked = false; */
//                         change_sketchpads(0);

//                         $('#svg-container').getHighlighter().setStrike('');
//                         $('#svg-container').getHighlighter().setColor('#ee7d7d');
//                         break;

//                     case "highlight_blue":

//                         $("#highlight_red, #highlight_green, #highlight_yellow").prop('checked', false);
//                         $('#svg-container').css({
//                             "cursor": "url(../images/blue.cur),default"
//                         });
//                         change_sketchpads(0);

//                         $('#svg-container').getHighlighter().setStrike('');
//                         $('#svg-container').getHighlighter().setColor('#80E6FF');
//                         /* $('.highlighted').live('mouseup', function() {
//                              var firstClass = $(this).attr("class").split(" ")[0];
                        
//                              $('#page-container').getHighlighter().removeHighlights(eval("'."+firstClass+"'"));
                     
//                              }); */
//                         break;

//                     case "highlight_green":

//                         $("#highlight_blue, #highlight_red,#highlight_yellow").prop('checked', false);
//                         change_sketchpads(0);
//                         $('#svg-container').css({
//                             "cursor": "url(../images/green.cur),default"
//                         });

//                         $('#svg-container').getHighlighter().setStrike('');
//                         $('#svg-container').getHighlighter().setColor('#99FF99');
//                         break;

//                     case "highlight_yellow":

//                         $("#highlight_blue, #highlight_red, #highlight_green").prop('checked', false);
//                         change_sketchpads(0);
//                         $('#svg-container').css({
//                             "cursor": "url(../images/yellow.cur),default"
//                         });
//                         $('#svg-container').getHighlighter().setStrike('');
//                         $('#svg-container').getHighlighter().setColor('#Fefe58');


//                         break;

//                     case "draw":

//                         remove_textbox_styles("");
//                         /* $.contextMenu( 'destroy' ); */
//                         $('#svg-container').textHighlighter();
//                         $('#svg-container').getHighlighter().destroy(); //to destroy the highlighter, it should be set then destroyed
//                         $('.highlight_colors').css('display', 'none');
//                         $('.draw_colors').css('display', 'block');
//                         $("#strike,#textbox, #highlight, #drop-comment,#drag-comment, #highlight_blue, #highlight_red, #highlight_green, #highlight_yellow,#draw_red, #draw_green, #draw_blue").prop('checked', false);

//                         document.getElementById("draw_black").checked = true;

//                         $('.clickable').unbind();
//                         change_sketchpads(1);



//                         /*  $('#svg-container').css({"cursor":"url(../../images/draw_black.cur),default"}); */
//                         change_draw_color('#000000');
//                         draw_state = 1;
//                         svg_cont_style("url(../images/draw_black.cur),default");
//                         draw_contextmenu();
//                         break;

//                     case "draw_black":
//                         //to destroy the highlighter, it should be set then destroyed
//                         //                                    $('.highlight_colors').css('display', 'none');
//                         //                                    $('.draw_colors').css('display', 'block');
//                         $("#draw_red, #draw_green, #draw_blue").prop('checked', false);

//                         $('#svg-container').css({
//                             "cursor": "url(../images/draw_black.cur),default"
//                         });
//                         change_draw_color('#000000');
//                         //                                    change_sketchpads(1,'#000000');
//                         draw_state = 1;
//                         break;

//                     case "draw_green":
//                         //to destroy the highlighter, it should be set then destroyed
//                         //                                      $('.highlight_colors').css('display', 'none');  
//                         $("#draw_black, #draw_red,#draw_blue").prop('checked', false);
//                         $('#svg-container').css({
//                             "cursor": "url(../images/draw_green.cur),default"
//                         });
//                         change_draw_color('#33CC33');
//                         draw_state = 1;
//                         break;

//                     case "draw_red":
//                         //to destroy the highlighter, it should be set then destroyed
//                         //                                      $('.highlight_colors').css('display', 'none');
//                         $('#svg-container').css({
//                             "cursor": "url(../images/draw_red.cur),default"
//                         });
//                         $("#draw_black,#draw_green, #draw_blue").prop('checked', false);
//                         document.getElementById("highlight").checked = false;
//                         document.getElementById("draw_black").checked = false;
//                         document.getElementById("draw_blue").checked = false;
//                         document.getElementById("draw_green").checked = false;
//                         document.getElementById("textbox").checked = false;
//                         change_draw_color('#FF0000');
//                         draw_state = 1;
//                         break;

//                     case "draw_blue":
//                         //to destroy the highlighter, it should be set then destroyed
//                         //                                      $('.highlight_colors').css('display', 'none');    
//                         $("#draw_black, #draw_red, #draw_green").prop('checked', false);
//                         $('#svg-container').css({
//                             "cursor": "url(../images/draw_blue.cur),default"
//                         });
//                         change_draw_color('#3366FF');
//                         draw_state = 1;
//                         break;


//                     case "drag-comment":

//                         remove_textbox_styles("text");
//                         /* $.contextMenu( 'destroy' ); */
//                         /* $("#svg-container").css({"cursor": "crosshair"});   */

//                         $('#svg-container').textHighlighter();
//                         $('#svg-container').getHighlighter().destroy();
//                         $('#svg-container').unbind();
//                         $('.clickable').unbind();
//                         contextmenu_activate();

//                         function showSelectionPosition() {

//                             var wholeSelRectEl, startSelEl, endSelEl;
//                             // Draw an element representing the whole selection rectangle
//                             var wholeSelRect = rangy.getSelection().getBoundingDocumentRect();

//                             //removeSelectionIndicators();

//                             if (!wholeSelRect) {
//                                 return;
//                             }
//                             var startPos = rangy.getSelection().getRangeAt(0).getStartClientPos();


//                             if ($.browser.mozilla) { //mozilla offsets the comment lines in x and y both, hence it needs to be adjusted             

//                                 //offset is from the start of the main text line, this selects it      
//                                 var parent_node_left_pos = $(rangy.getSelection().getRangeAt(0).startContainer.parentNode).closest('.t').offset().left - $("#svg-container").offset().left;

//                                 var new_xpos = ((startPos.x - parent_node_left_pos - $("#svg-container").offset().left) / 3) + $("#svg-container").offset().left + parent_node_left_pos;

//                                 var new_ypos = startPos.y + 17; // 16 is an arbitary value, not perfect at all
//                                 // height of the highlight is to be obtained in place of 16 
//                                 return [new_xpos, new_ypos];
//                             } else { //for chrome and others

//                                 return [startPos.x, startPos.y];

//                             }
//                             var endPos = rangy.getSelection().getEndDocumentPos();
//                         }


//                         document.getElementById("svg_id").style.pointerEvents = "none";


//                         $('#svg-container').textHighlighter({

//                             onBeforeHighlight: function(range) {
//                                 var pos_drag = showSelectionPosition();
//                                 window.y_pos_drag = pos_drag[1];
//                                 window.x_pos_drag = pos_drag[0];



//                                 return true;
//                             },
//                             onAfterHighlight: function(highlights, range) {


//                                 var drag_highlight_class = $(highlights[0]).attr('class').split(' ')[1];
                               
//                                 create_drag_comment(y_pos_drag - $("#svg-container").offset().top, drag_highlight_class);
                               
//                                 var page_no = (Math.ceil((y_pos_drag - $("#svg-container").offset().top) / (page_height + 13)) > cnt ? cnt : Math.ceil((y_pos_drag - $("#svg-container").offset().top) / (page_height + 13)));
                               
//                                 add_history(drag_highlight_class, range, page_no, "Text comment");
                               
//                                 var json_str = high.serializeHighlights();


//                                 commentBoxCords[drag_highlight_class].highlight = highlightedSeries(json_str, drag_highlight_class);
//                                 //console.log(sendJsonString);



//                             }




//                         });
//                         var high = $('#svg-container').getHighlighter();
//                         high.setStrike('');
//                         high.setColor('#FB8520');


//                         $('.highlight_colors').css('display', 'none');
//                         $('.draw_colors').css('display', 'none');


//                         $("#draw, #strike, #highlight, #drop-comment, #highlight_blue, #highlight_red, #highlight_green, #highlight_yellow, #draw_black, #draw_red, #draw_green, #draw_blue, #textbox").prop('checked', false);
//                         change_sketchpads(0);

//                         svg_cont_style("url(../images/drag.cur),default");


//                         function create_drag_comment(y_drag, drag_highlight_class) {

//                             commentBoxId = random_class_generator();

//                             check_empty_commentbox();

//                             /* $('#svg-container').css({'position':'absolute','height':'auto','left': svg_left("after"),'cursor':'url(../../images/drag.cur),default'}); */
//                             $('#comment-container').css('display', 'block');
//                             /*  $('#svg-container').css('left', '30.1015px'); */


//                             function checkCoords(y) {

//                                 var click_y_coord = y;

//                                 //storing aligned-original y-top positions of comment boxes

//                                 original_aligned_y.push([click_y_coord]);

//                                 original_aligned_y.sort(function(a, b) {
//                                     return a - b
//                                 });

//                                 if ($(".comment-box").length == 0) {

//                                     all_click_y_positions.push([y, commentBoxId]);
//                                     /* console.log(all_click_y_positions); */
//                                 }

//                                 if ($(".comment-box").length > 0) {


//                                     window.col1 = all_click_y_positions.map(function(value, index) {
//                                         return value[0];
//                                     }); //map working for IE9+
//                                     window.col2 = all_click_y_positions.map(function(value, index) {
//                                         return value[1];
//                                     });

//                                     all_click_y_positions.push([y, commentBoxId]);


//                                     var getClosestValues = function(a, x) {



//                                         /* var a = b.map(function(value,index) { return value[0]; });
//                                          var col2 =  b.map(function(value,index) { return value[1]; }); */

//                                         var lo, hi, array_position;
//                                         for (var i = 0; i < a.length; i++) {
//                                             if (a[i] <= x && (lo === undefined || lo < a[i])) {
//                                                 lo = a[i];
//                                                 array_position = col2[i]
//                                             };
//                                             if (a[i] >= x && (hi === undefined || hi > a[i]))
//                                                 hi = a[i];
//                                         };
//                                         return [lo, hi, array_position];
//                                     }


//                                     window.result = getClosestValues(col1, y); // [5, 9]


//                                     $ts = $(".comment-box");

//                                     for (var i = 0; i < $ts.length; i++) {



//                                         var $ti = $ts.eq(i);

//                                         var tcoords = [$ti.offset().top - $ti.parent().offset().top, $ti.offset().top + $ti.height() - $ti.parent().offset().top, $ti.attr('id')]

//                                         if (click_y_coord >= tcoords[0] && click_y_coord <= tcoords[1]) {

//                                             /*   console.log("top is in id: "+tcoords[2]); */

//                                             y = $("#" + result[2]).offset().top - $("#" + result[2]).parent().offset().top + $("#" + result[2]).height() + 10;

//                                             /* 
//                                              y = eval("$('#"+result[2]+"').offset().top - $('#"+result[2]+"').parent().offset().top + $('#"+result[2]+"').height()+ 10");
//                                              */


//                                         }
//                                         /*    else if((click_y_coord +50)>=tcoords[0] && (click_y_coord +50)<= tcoords[1]){
//                                          eval("$('#"+tcoords[2]+"').css('top','"+(y+50+10)+"px');");
//                                          } */


//                                     }
//                                 }
//                                 return y;
//                             }

//                             var offset = $(this).offset();
//                             var comment_box_y_coord = checkCoords(y_drag);





//                             if ($('#comment-container').children().length == 0 && comm_del == 0) {


//                                 comment_lines(x_pos_drag - $("#svg-container").offset().left, y_pos_drag - $("#svg-container").offset().top, 800, y_pos_drag - $("#svg-container").offset().top, drag_highlight_class);
//                                 connector_lines((y_pos_drag - $("#svg-container").offset().top), comment_box_y_coord, drag_highlight_class);

//                             } else {

//                                 comment_lines(x_pos_drag - $("#svg-container").offset().left, y_pos_drag - $("#svg-container").offset().top, 800, y_pos_drag - $("#svg-container").offset().top, drag_highlight_class);
//                                 connector_lines((y_pos_drag - $("#svg-container").offset().top), comment_box_y_coord, drag_highlight_class);

//                             }
//                             var newOffset = $("#svg-container").offset();

//                             commentBoxCords[drag_highlight_class] = {
//                                 pageX: x_pos_drag,
//                                 pageY: y_pos_drag,
//                                 offsetTop: newOffset.top,
//                                 offsetLeft: newOffset.left,
//                                 boxY: y_drag,
//                                 type: "drag"
//                             };

//                             if (typeof result === 'undefined') {
//                                 //  dropCommentObject.result = null;
//                             } else {
//                                 commentBoxCords[drag_highlight_class].result = result;
//                             }


//                             var rndLiId = random_comm_id_generator();

//                             if ($(".comment-box").length == 0) {

//                                 //alert(commentBoxId);

//                                 $("#comment-container").append('<ul class="comment-box ' + drag_highlight_class + '" id="' + commentBoxId + '"' +
//                                     ' style="top:' + comment_box_y_coord + 'px;">' +
//                                     '<li id = ' + rndLiId + '>' +
//                                     '<span class="critic_name" contenteditable="false">' + user + ':</span>' +
//                                     '<span class="trash-comment"><img src="../images/trash.png"></span>' +
//                                     '<textarea class="active-comment autoExpand" rows="3" data-min-rows="3" spellcheck="false" autofocus></textarea>' +
//                                     '</li>' +

//                                     '<a class="new-comment new-comm-inactive">new comment</a>' +
//                                     '<a class="submit-comment submit-inactive">submit</a>' +

//                                     '</ul>');
//                             } else if (result[2] == undefined) {

//                                 $("#comment-container").prepend('<ul class="comment-box ' + drag_highlight_class + '" id="' + commentBoxId + '"' +
//                                     ' style="top:' + comment_box_y_coord + 'px;">' +
//                                     '<li id = ' + rndLiId + '>' +
//                                     '<span class="critic_name" contenteditable="false">' + user + ':</span>' +
//                                     '<span class="trash-comment"><img src="../images/trash.png"></span>' +
//                                     '<textarea class="active-comment autoExpand" rows="3" data-min-rows="3" spellcheck="false" autofocus></textarea>' +
//                                     '</li>' +

//                                     '<a class="new-comment new-comm-inactive">new comment</a>' +
//                                     '<a class="submit-comment submit-inactive">submit</a>' +

//                                     '</ul>');
//                             } else {


//                                 $("#comment-container #" + result[2]).after('<ul class="comment-box ' + drag_highlight_class + '" id="' + commentBoxId + '"' +
//                                     'style="top:' + comment_box_y_coord + 'px;">' +
//                                     '<li id = ' + rndLiId + '>' +
//                                     '<span class="critic_name" contenteditable="false">' + user + ':</span>' +
//                                     '<span class="trash-comment"><img src="../images/trash.png"></span>' +
//                                     '<textarea class="active-comment autoExpand" rows="3" data-min-rows="3" spellcheck="false" autofocus></textarea>' +
//                                     '</li>' +

//                                     '<a class="new-comment new-comm-inactive">new comment</a>' +
//                                     '<a class="submit-comment submit-inactive">submit</a>' +

//                                     '</ul>');



//                             }




//                             $("#" + commentBoxId).resize(function() {

//                                 height_change_align_comment_boxes($(this).parent().children().index(this));

//                             });

//                             new_box_entry_align_comment_boxes(); //align on new box entry


//                         }

//                         break;


//                     case "drop-comment":

//                         remove_textbox_styles("url(../images/drop_comment.cur),default");
//                         $.contextMenu('destroy');
//                         // drop_contextmenu();
//                         $('#svg-container').unbind();
//                         $('.clickable').unbind();
//                         $('#svg-container').textHighlighter();
//                         $('#svg-container').getHighlighter().destroy();


//                         $('.highlight_colors').css('display', 'none');
//                         $('.draw_colors').css('display', 'none');



//                         $("#draw, #strike, #highlight, #drag-comment, #highlight_blue, #highlight_red, #highlight_green, #highlight_yellow, #draw_black, #draw_red, #draw_green, #draw_blue, #textbox").prop('checked', false);
//                         change_sketchpads(0);

//                         svg_cont_style("url(../images/drop_comment.cur),default");

//                         document.getElementById("svg_id").style.pointerEvents = "none";
//                         /*  $("#svg-container").css('cursor','url(../../images/openhand.cur) 3 12 , url(../../images/openhand.cur), text '); */





//                         $('#svg-container').mousedown(function(e) {

//                                 if (e.which == 1) {


//                                     commentBoxId = random_class_generator();

//                                     check_empty_commentbox();

//                                     $('#comment-container').css('display', 'block');
//                                     /* $('#svg-container').css('left', '30.1015px'); */
//                                     /*  $('#svg-container').css({'position':'absolute','height':'auto','left': svg_left("after"),'cursor':'url(../../images/drop_comment.cur),default'}); */


//                                     function checkCoords(y) {
//                                         /* console.log(y); */
//                                         var click_y_coord = y;

//                                         //storing aligned-original y-top positions of comment boxes


//                                         original_aligned_y.push([click_y_coord]);
//                                         /*  console.log("original_stored:" + original_aligned_y); */
//                                         original_aligned_y.sort(function(a, b) {
//                                             return a - b
//                                         });
//                                         // console.log("original_aligned_y_sorted:" + original_aligned_y); 

//                                         // console.log(original_aligned_y);


//                                         if ($(".comment-box").length == 0) {

//                                             all_click_y_positions.push([y, commentBoxId]);
//                                             console.log(all_click_y_positions);
//                                         }

//                                         if ($(".comment-box").length > 0) {


//                                             window.col1 = all_click_y_positions.map(function(value, index) {
//                                                 return value[0];
//                                             }); //map working for IE9+
//                                             window.col2 = all_click_y_positions.map(function(value, index) {
//                                                 return value[1];
//                                             });

//                                             all_click_y_positions.push([y, commentBoxId]);
//                                             // console.log("all_click_y_pos: " + all_click_y_positions);

//                                             var getClosestValues = function(a, x) {

//                                                 /* var a = b.map(function(value,index) { return value[0]; });
//                                                  var col2 =  b.map(function(value,index) { return value[1]; }); */



//                                                 var lo, hi, array_position;
//                                                 for (var i = 0; i < a.length; i++) {
//                                                     if (a[i] <= x && (lo === undefined || lo < a[i])) {
//                                                         lo = a[i];

//                                                         array_position = col2[i];

//                                                     };
//                                                     if (a[i] >= x && (hi === undefined || hi > a[i]))
//                                                         hi = a[i];
//                                                 };
//                                                 return [lo, hi, array_position];
//                                             }


//                                             window.result = getClosestValues(col1, y); // [5, 9]

//                                             // console.log("result array" + result);
//                                             $ts = $(".comment-box");

//                                             for (var i = 0; i < $ts.length; i++) {


//                                                 var $ti = $ts.eq(i);

//                                                 var tcoords = [$ti.offset().top - $ti.parent().offset().top, $ti.offset().top + $ti.height() - $ti.parent().offset().top, $ti.attr('id')]



//                                                 if (click_y_coord >= tcoords[0] && click_y_coord <= tcoords[1]) {



//                                                     y = $("#" + result[2]).offset().top - $("#" + result[2]).parent().offset().top + $("#" + result[2]).height() + 10;

//                                                 }

//                                             }
//                                         }
//                                         return y;
//                                     }




//                                     var offset = $(this).offset();
//                                     var comment_box_y_coord = checkCoords(e.pageY - offset.top);




//                                     var rnd_drop = random_class_generator();

//                                     if ($('#comment-container').children().length == 0 && comm_del == 0) { //if first ever commentbox is to be put





//                                         $("#image-container").append("<img class='drop-comment " + rnd_drop + "' style='z-index:100;position:absolute;top:" + (e.pageY - offset.top - 24) + "px;left:" + (e.pageX - 200 - 19 + $("#page-container").scrollLeft()) + "px' src='../images/drop_pin.cur'>");

//                                         comment_lines((e.pageX - offset.left), (e.pageY - offset.top), 800, (e.pageY - offset.top), rnd_drop);
//                                         connector_lines((e.pageY - offset.top), comment_box_y_coord, rnd_drop);




//                                     } else {



//                                         $("#image-container").append("<img class='drop-comment " + rnd_drop + "' style='z-index:100;position:absolute;top:" + (e.pageY - offset.top - 24) + "px;left:" + (e.pageX - 200 - 19 + $("#page-container").scrollLeft()) + "px' src='../images/drop_pin.cur'>")

//                                         comment_lines((e.pageX - offset.left), (e.pageY - offset.top), 800, (e.pageY - offset.top), rnd_drop);
//                                         connector_lines((e.pageY - offset.top), comment_box_y_coord, rnd_drop);


//                                     }


//                                     // console.log(comment_box_y_coord);
//                                     commentBoxCords[rnd_drop] = {
//                                         pageX: e.pageX,
//                                         pageY: e.pageY,
//                                         offsetTop: offset.top,
//                                         offsetLeft: offset.left,
//                                         boxY: e.pageY - offset.top,
//                                         type: "drop"
//                                     };


//                                     if (typeof result === 'undefined') {
//                                         //  dropCommentObject.result = null;
//                                     } else {
//                                         commentBoxCords[rnd_drop].result = result;
//                                     }






//                                     var rnd_comm_id = random_comm_id_generator();
//                                     //dropCommentObject.comLiId = rnd_comm_id;
//                                     if ($(".comment-box").length == 0) { // first ever commentbox



//                                         $("#comment-container").append('<ul class="comment-box ' + rnd_drop + '" id="' + commentBoxId + '"' +
//                                             ' style="top:' + comment_box_y_coord + 'px;">' +
//                                             '<li id = ' + rnd_comm_id + '>' +
//                                             '<span class="critic_name" contenteditable="false">' + user + ':</span>' +
//                                             '<span class="trash-comment"><img src="../images/trash.png"></span>' +
//                                             '<textarea class="active-comment autoExpand" rows="3" data-min-rows="3" spellcheck="false" autofocus></textarea>' +
//                                             '</li>' +

//                                             '<a class="new-comment new-comm-inactive">new comment</a>' +
//                                             '<a class="submit-comment submit-inactive">submit</a>' +

//                                             '</ul>');

//                                     } else if (result[2] == undefined) { // a box is  not present at needed y position

//                                         $("#comment-container").prepend('<ul class="comment-box ' + rnd_drop + '" id="' + commentBoxId + '"' +
//                                             ' style="top:' + comment_box_y_coord + 'px;">' +
//                                             '<li id = ' + rnd_comm_id + '>' +
//                                             '<span class="critic_name" contenteditable="false">' + user + ':</span>' +
//                                             '<span class="trash-comment"><img src="../images/trash.png"></span>' +
//                                             '<textarea class="active-comment autoExpand" rows="3" data-min-rows="3" spellcheck="false" autofocus></textarea>' +
//                                             '</li>' +
//                                             '<a class="new-comment new-comm-inactive">new comment</a>' +
//                                             '<a class="submit-comment submit-inactive">submit</a>' +

//                                             '</ul>');

//                                     } else { // a box is  already present at needed y position


//                                         $("#comment-container #" + result[2]).after('<ul class="comment-box ' + rnd_drop + '" id="' + commentBoxId + '"' +
//                                             'style="top:' + comment_box_y_coord + 'px;">' +
//                                             '<li id = ' + rnd_comm_id + '>' +
//                                             '<span class="critic_name" contenteditable="false">' + user + ':</span>' +
//                                             '<span class="trash-comment"><img src="../images/trash.png"></span>' +
//                                             '<textarea class="active-comment autoExpand" rows="3" data-min-rows="3" spellcheck="false" autofocus></textarea>' +
//                                             '</li>' +

//                                             '<a class="new-comment new-comm-inactive">new comment</a>' +
//                                             '<a class="submit-comment submit-inactive">submit</a>' +

//                                             '</ul>');

//                                     }

//                                     var page_no = (Math.ceil((e.pageY - offset.top) / (page_height + 13)) > cnt ? cnt : Math.ceil((e.pageY - offset.top) / (page_height + 13)));
//                                     add_history(rnd_drop, "[Pin comment]", page_no, "Pin comment");


//                                     $("#" + commentBoxId).resize(function() {
//                                         /* console.log("resize drop"); */
//                                         height_change_align_comment_boxes($(this).parent().children().index(this));

//                                     });

//                                     new_box_entry_align_comment_boxes();

//                                 } /*end of if(e.which == 1)*/
//                                 else {

//                                     //no right or middle click allowed
//                                 }

//                             } /* end of mouse down in drop-comment */

//                         )

//                         break;

//                     default:

//                         break;

//                 }

//             } else { //when unchecked
//                 $.contextMenu('destroy');
//                 $('.highlight_colors').css('display', 'none');
//                 $('.draw_colors').css('display', 'none');
//                 $('#svg-container').textHighlighter();
//                 $('#svg-container').getHighlighter().destroy();

//                 change_sketchpads(0);
//                 svg_cont_style("text");
//                 document.getElementById("svg_id").style.pointerEvents = "none";
//                 $('.clickable').unbind('click');
//                 $('#svg-container').unbind();
//                 $('#svg-container').css({
//                     "cursor": "text"
//                 });
//             }
//         }

//         function new_top_calculator(x) {
//             return x + 'px';
//         };

//         function new_box_entry_align_comment_boxes() {


//             $('#comment-container > .comment-box').each(function() {

//                 if ($(this).parent().children().index(this) > 0) {

//                     if (($(this).offset().top - $(this).parent().offset().top) - ($(this).prev().offset().top - $(this).parent().offset().top + $(this).prev().height()) < 10) {

//                         window.new_top = $(this).prev().offset().top + $(this).prev().height() - $(this).parent().offset().top + 10;
//                         /* $(this).css('top',eval("'"+ new_top +"px'")); */

//                         $(this).css('top', new_top_calculator(new_top));

//                         $("#connector-svg > ." + $(this).attr('class').split(' ')[1]).attr("y2", new_top_calculator(new_top));
//                         // commentBoxCords[$(this).attr('class').split(' ')[1]].boxY = new_top;
//                     } else {};
//                 }
//             })
//         }

//         function height_change_align_comment_boxes(check_resized_box_index) {


//             $('#comment-container > .comment-box').each(function() {



//                 if ($(this).parent().children().index(this) > check_resized_box_index) {

//                     if ((($(this).offset().top - $(this).parent().offset().top) - ($(this).prev().offset().top - $(this).parent().offset().top + $(this).prev().height())) < 10) {

//                         window.new_top_move_down = $(this).prev().offset().top + $(this).prev().height() - $(this).parent().offset().top + 10;
//                         /*  $(this).css('top',eval("'"+ new_top_move_down +"px'")); */
//                         $(this).css('top', new_top_calculator(new_top_move_down));

//                         $("#connector-svg > ." + $(this).attr('class').split(' ')[1]).attr("y2", new_top_calculator(new_top_move_down));


//                     } else if ((($(this).offset().top - $(this).parent().offset().top) - ($(this).prev().offset().top - $(this).parent().offset().top + $(this).prev().height())) > 10) {

//                         var new_top_move_up = $(this).prev().offset().top + $(this).prev().height() - $(this).parent().offset().top + 10;

//                         if (original_aligned_y[$(this).parent().children().index(this)] > new_top_move_up) {

//                             new_top_move_up = original_aligned_y[$(this).parent().children().index(this)];
//                         };
//                         /* $(this).css('top',eval("'"+ new_top_move_up +"px'")); */
//                         $(this).css('top', new_top_calculator(new_top_move_up));


//                         $("#connector-svg > ." + $(this).attr('class').split(' ')[1]).attr("y2", new_top_calculator(new_top_move_up));


//                     } else {
//                         //no movement needed
//                     }
//                 } else { // less than the required index 
//                 };
//             })


//         }




//         function align_page() {

//             window.original_aligned_y = [];
//             all_click_y_positions = [];
//             window.commentBoxId = "random_useless";
//             var page_scroll_no_latest = 1;
//             var total_pages = $('.pf').length;
//             window.page_height = $(".pf").height();
//             var first_pg_id = "#" + $("#svg-container:first-child").attr('id');
//             window.cnt = $('.pf').length;



//             $(".close_info").click(function() {
//                 $("#del-info").remove();

//             });

//             $("#display-history").click(function() {
//                 if ($('#history').children().length > 0) {
//                     $("#history").toggle("fast", function() {

//                         if ($("#history").css('display') == "block") {

//                             $("#up-pull").css("display", "block");
//                             $("#down-drop").css("display", "none");
//                         } else if ($("#history").css('display') == "none") {

//                             $("#up-pull").css('display', 'none');
//                             $("#down-drop").css('display', 'block');
//                         }

//                     });


//                 }

//             });



//             $("#history-container").perfectScrollbar();

//             $('#history').bind('DOMNodeInserted', function() {

//                 if ($("#history").css('display') == "block") {

//                     $("#up-pull").css('display', 'block');
//                     $("#down-drop").css('display', 'none');

//                 } else if ($("#history").css('display') == "none") {

//                     $("#up-pull").css('display', 'none');
//                     $("#down-drop").css('display', 'block');

//                 }


//                 $("#count-history").html($('#history').children().length);
//             });

//             $('#history').bind('DOMNodeRemoved', function() {

//                 if ($('#history').children().length - 1 == 0) {
//                     $("#count-history").html("0");
//                     $("#down-drop").css("display", "none");
//                     $("#up-pull").css("display", "none");
//                 } else {
//                     $("#count-history").html($('#history').children().length - 1);
//                 }
//             });
//             $("#page-up").click(function() {

//                 if (page_scroll_no_latest > 1) {

//                     $("#page-container").scrollTo("#" + $("#svg-container > div:nth-child(" + (page_scroll_no_latest - 1) + ")")[0].id);

//                 }

//             })

//             $("#page-down").click(function() {

//                 if (page_scroll_no_latest < total_pages) {

//                     $("#page-container").scrollTo("#" + $("#svg-container > div:nth-child(" + (page_scroll_no_latest + 1) + ")")[0].id);

//                 }

//             })





//             /* set page no on scroll */

//             $("#page-container").bind('scroll', function(e) {
//                 $('.pf').each(function() {
//                     if (
//                         $(this).offset().top < window.pageYOffset + ($(window).height() / 2)
//                         //begins before top
//                         && $(this).offset().top + $(this).height() > window.pageYOffset + ($(window).height() / 2)
//                         //but ends in visible area
//                         //+ 10 allows you to change hash before it hits the top border
//                     ) {

//                         /* window.location.hash = $(this).attr('id');   */

//                         $("#page_no")[0].value = $(this).index() + 1;
//                         page_scroll_no_latest = $(this).index() + 1;
//                     }
//                 });
//             });


//             $("#page_no").keypress(function(e) {
//                 if (e.keyCode == 13) {
//                     var page_no = $(this)[0].value;

//                     if (page_no <= total_pages && page_no > 0) {

//                         $("#page-container").scrollTo("#" + $("#svg-container > div:nth-child(" + page_no + ")").attr('id'));
//                         page_scroll_no_latest = $("#page_no")[0].value;

//                     } else if (page_no > total_pages) {

//                         $("#page-container").scrollTo("#" + $("#svg-container > div:nth-child(" + total_pages + ")").attr('id'));
//                         $("#page_no")[0].value = total_pages;
//                         page_scroll_no_latest = total_pages;

//                     } else if (page_no == 0) {
//                         $("#page-container").scrollTo("#" + $("#svg-container > div:nth-child(1)").attr('id'));
//                         $("#page_no")[0].value = 1;
//                         page_scroll_no_latest = 1;

//                     }
//                 }
//             });





//             $("#page-container").scrollTo('first_pg_id');
//             $("#page_no")[0].value = "1";




//             for (var i = 0; i < cnt; i++) {

//                 document.getElementsByClassName('pc')[i].setAttribute("id", "button" + i);

//                 if (document.getElementById("button" + i).getElementsByTagName('img')[0] != undefined) {
//                     document.getElementById("button" + i).getElementsByTagName('img')[0].setAttribute("draggable", "false");

//                 } //if condition is coz, image for every page may not be created
//             }

//             var page_cont_width = $("#page-container").width();

//             var svg_height = $("#svg-container").height();
//             var svg_width = $(".pf").width();




//             var svg_cont_left = 15+"px";

//             var conn_cont_left = svg_width + "px";
//             var comm_cont_left = svg_width + 27 + "px";

//             console.log("svg_width: " + svg_width);


//             var name = "sketchpad";

//             var svg_width_px = svg_width + "px";

//             /* $("#svg-container").css('width',svg_width_px);  */



//             var connector_ht = svg_height + "px";
//             $("#connector-container").css('height', connector_ht);

//             window.sketchpad = Raphael.sketchpad("svg-container", {
//                 width: svg_width,
//                 height: svg_height,
//                 editing: true

//             });

//             sketchpad.change(function() {



//                 var recent_created_path = $("#svg_id").children("path:last");

//                 //console.log(recent_created_path);

//                 var drawObject = {
//                     d: recent_created_path.attr('d'),
//                     pathClass: recent_created_path.attr('class').split(' ')[1],
//                     color: recent_created_path.attr('stroke')

//                 };
//                 //console.log(drawObject);
//                 sendChangeData(drawObject, "draw-create");


//                 var xmlns = "http://www.w3.org/2000/svg";
//                 var elem = document.createElementNS(xmlns, "path");

//                 /* 	elem.setAttributeNS(null,"style",recent_created_path.attr('style')); */
//                 elem.setAttributeNS(null, "fill", "none");
//                 elem.setAttributeNS(null, "stroke", "#bbb000");
//                 elem.setAttributeNS(null, "d", recent_created_path.attr('d'));
//                 elem.setAttributeNS(null, "stroke-opacity", "0");
//                 elem.setAttributeNS(null, "stroke-width", "20");
//                 elem.setAttributeNS(null, "stroke-linecap", "round");
//                 elem.setAttributeNS(null, "stroke-linejoin", "round");
//                 elem.setAttributeNS(null, "class", recent_created_path.attr('class'));

//                 document.getElementById('svg_id').appendChild(elem);


//                 var draw_start_y_coord = $("#svg_id :last-child")[0].pathSegList.getItem(0).y;
//                 var page_no = (Math.ceil(draw_start_y_coord / (page_height + 13)) > cnt ? cnt : Math.ceil(draw_start_y_coord / (page_height + 13)));

//                 add_history(recent_created_path.attr('class').split(' ')[1], "[Draw]", page_no, "Draw");
//                 historyObject = {
//                     append_class: recent_created_path.attr('class').split(' ')[1],
//                     append_text: "[Draw]",
//                     page_no: page_no,

//                 }



//             });

//             //Assigns an id to SVG tag of the page

//             document.getElementById('svg-container').children[0].setAttribute("id", "svg_id");

//             $("#svg-container").append($("#svg_id"));
//             //$("#svg-container").children[0].remove();
//             $("#svg_id").css({
//                 position: "absolute",
//                 top: "0px"
//             });

//             sketchpad.editing(false);
//             /* (eval("sketchpad")).editing(false); */
//             window.draw_state = 0;




//             $('#svg-container').css({
//                 'position': 'absolute',
//                 'height': 'auto',
//                 'left': svg_left("after"),
//                 'cursor': 'url(../images/drag.cur),default'
//             });
//             $('#connector-container').css({
//                 'position': 'absolute',
//                 'left': conn_cont_left,
//                 'top': '0px',
//                 'width': '27'
//             });

//             $('#comment-container').css({
//                 'position': 'absolute',
//                 'left': comm_cont_left,
//                 'top': '0px',
//                 'width': '185',
//                 'height': '100%',
//                 'z-index': '10',
//                 'display': 'block'
//             });


//         }
//     </script>




    <style type="text/css">
        /* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab filetype=css: */
        /*! 
 * Base CSS for pdf2htmlEX
 * Copyright 2012,2013 Lu Wang <coolwanglu@gmail.com> 
 * https://github.com/coolwanglu/pdf2htmlEX/blob/master/share/LICENSE
 */
        /* Part 1: Web Page Layout: Free to modify, except for a few of them which are required by pdf2htmlEX.js, see the comments */
        
        #sidebar {
            /* Sidebar */
            
            position: absolute;
            top: 35px;
            left: 0;
            bottom: 0;
            width: 200px;
            padding: 0;
            margin: 0px;
            overflow: hidden;
        }
        #page-container {
            /* PDF container */
            
            position: absolute;
            /* required for calulating relative positions of pages in pdf2htmlEX.js */
            
            top: 35px;
            left: 0px;
            margin: 0;
            padding: 0;
            border: 0;
            /* required for lazy page loading in pdf2htmlEX.js (page visibility test) */
        }
        @media screen {
            /* for sidebar */
            
            #sidebar.opened + #page-container {
                left: 200px;
            }
            #page-container {
                /* `bottom' and `right' are required for lazy page loading in pdf2htmlEX.js (page visibility test)
     * alternatively you may set width and height
     */
                
                bottom: 0;
                right: 0;
                overflow: auto;
            }
            .loading-indicator {
                display: none;
            }
            .loading-indicator.active {
                display: block;
                position: absolute;
                width: 64px;
                height: 64px;
                top: 50%;
                left: 50%;
                margin-top: -32px;
                margin-left: -32px;
            }
            .loading-indicator img {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
            }
        }
        @media print {
            @page {
                margin: 0;
            }
            html {
                margin: 0;
            }
            body {
                margin: 0;
                -webkit-print-color-adjust: exact;
                /* enable printing background images for WebKit */
            }
            #sidebar {
                display: none;
            }
            #page-container {
                width: auto;
                height: auto;
                overflow: visible;
                background-color: transparent;
            }
            .d {
                display: none;
            }
        }
        /* Part 2: Page Elements: Modify with caution
 * The followings are base classes, some of which are meant to be override by PDF specific classes
 * So do not increase the specificity (e.g. ".classname" -> "#page-container .classname")
 */
        
        .pf {
            /* page */
            
            position: relative;
            background-color: white;
            overflow: hidden;
            margin: 0;
            border: 0;
            /* required by pdf2htmlEX.js for page visibility test */
        }
        .pc {
            /* content of a page */
            
            position: absolute;
            border: 0;
            padding: 0;
            margin: 0;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: block;
            /* set transform-origin for scaling */
            
            transform-origin: 0% 0%;
            -ms-transform-origin: 0% 0%;
            -webkit-transform-origin: 0% 0%;
        }
        .pc.opened {
            /* used by pdf2htmlEX.js, to show/hide pages */
            
            display: block;
        }
        .bf {
            /* images that occupies the whole page */
            
            position: absolute;
            border: 0;
            margin: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            -ms-user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .bi {
            /* images that cover only a part of the page */
            
            position: absolute;
            border: 0;
            margin: 0;
            -ms-user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            user-select: none;
        }
        @media print {
            .pf {
                margin: 0;
                box-shadow: none;
                page-break-after: always;
                page-break-inside: avoid;
            }
            @-moz-document url-prefix() {
                /* fix page truncation for FireFox */
                
                .pf {
                    overflow: visible;
                    border: 1px solid #FFFFFF;
                }
                .pc {
                    overflow: visible;
                }
            }
        }
        .c {
            /* clip box */
            
            position: absolute;
            border: 0;
            padding: 0;
            margin: 0;
            overflow: hidden;
            display: block;
        }
        .t {
            /* text line */
            
            position: absolute;
            white-space: pre;
            font-size: 1px;
            transform-origin: 0% 100%;
            -ms-transform-origin: 0% 100%;
            -webkit-transform-origin: 0% 100%;
            unicode-bidi: bidi-override;
            /* For rtl lanauges, e.g. Hebrew, we don't want the default Unicode behaviour */
            
            -moz-font-feature-settings: "liga" 0;
            /* We don't want Firefox to recognize ligatures */
        }
        span {
            /* text blocks within a line */
            
            position: relative;
            vertical-align: baseline;
            /* _<id> for spaces may need display:inline, which will override this */
            
            display: inline-block;
            unicode-bidi: bidi-override;
            /* For rtl lanauges, e.g. Hebrew, we don't want the default Unicode behaviour */
        }
        ._ {
            /* text shift */
            
            color: transparent;
            z-index: -1;
        }
        /* selection background should not be opaque, for fallback mode */
        
        ::selection {
            background: rgba(127, 255, 255, 0.4);
        }
        ::-moz-selection {
            background: rgba(127, 255, 255, 0.4);
        }
        .pi {
            /* info for Javascript */
            
            display: none;
        }
        .l {
            /* annotation links */
        }
        /* transparent color - WebKit */
        
        .d {
            /* css drawing */
            
            position: absolute;
            transform-origin: 0% 100%;
            -ms-transform-origin: 0% 100%;
            -webkit-transform-origin: 0% 100%;
        }
        /* Base CSS END */
    </style>
    <style type="text/css">
        /* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab filetype=css: */
        /*! 
 * Fancy styles for pdf2htmlEX
 * Copyright 2012,2013 Lu Wang <coolwanglu@gmail.com> 
 * https://github.com/coolwanglu/pdf2htmlEX/blob/master/share/LICENSE
 */
        
        @keyframes fadein {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @-webkit-keyframes fadein {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes swing {
            0% {
                transform: rotate(0deg);
            }
            10% {
                transform: rotate(0deg);
            }
            90% {
                transform: rotate(720deg);
            }
            100% {
                transform: rotate(720deg);
            }
        }
        @-webkit-keyframes swing {
            0% {
                -webkit-transform: rotate(0deg);
            }
            10% {
                -webkit-transform: rotate(0deg);
            }
            90% {
                -webkit-transform: rotate(720deg);
            }
            100% {
                -webkit-transform: rotate(720deg);
            }
        }
        @media screen {
            #sidebar {
                background-color: white;
                /* modified from http://philbit.com/svgpatterns/#crossstripes */
            }
            #outline {
                font-family: Georgia, Times, "Times New Roman", serif;
                font-size: 13px;
                margin: 2em 1em;
            }
            #outline ul {
                padding: 0;
            }
            #outline li {
                list-style-type: none;
                margin: 1em 0;
            }
            #outline li > ul {
                margin-left: 1em;
            }
            #outline a,
            #outline a:visited,
            #outline a:hover,
            #outline a:active {
                line-height: 1.2;
                color: #e8e8e8;
                text-overflow: ellipsis;
                white-space: nowrap;
                text-decoration: none;
                display: block;
                overflow: hidden;
                outline: 0;
            }
            #outline a:hover {
                color: rgb(0, 204, 255);
            }
            #page-container {
                background-color: #ede9e9;
                /* http://philbit.com/svgpatterns/#thinstripes */
                
                -webkit-transition: left 500ms;
                transition: left 500ms;
            }
            .pf {
                margin: 13px auto;
                box-shadow: 1px 1px 3px 1px #333;
                /* Needed by IE to make box-shadow works * https://developer.mozilla.org/en-US/docs/Web/CSS/box-shadow */
                
                border-collapse: separate;
            }
            .pc.opened {
                /* used by pdf2htmlEX.js, to show/hide pages */
                
                -webkit-animation: fadein 100ms;
                animation: fadein 100ms;
            }
            .loading-indicator.active {
                /* 
     * use 0.01s instead of 0s,
     * since YUI Compressor will change 0s to 0,
     * which is not recognized by Firefox
     */
                
                -webkit-animation: swing 1.5s ease-in-out 0.01s infinite alternate none;
                animation: swing 1.5s ease-in-out 0.01s infinite alternate none;
            }
        }
        /* Fancy CSS END */
    </style>

    <script>
        /*
                         Copyright 2012 Mozilla Foundation 
                         Copyright 2013 Lu Wang <coolwanglu@gmail.com>
                         Apachine License Version 2.0 
                        */
        (function() {
            function b(a, b, e, f) {
                var c = (a.className || "").split(/fs+/g);
                "" === c[0] && c.shift();
                var d = c.indexOf(b);
                0 > d && e && c.push(b);
                0 <= d && f && c.splice(d, 1);
                a.className = c.join(" ");
                return 0 <= d
            }
            if (!("classList" in document.createElement("div"))) {
                var e = {
                    add: function(a) {
                        b(this.element, a, !0, !1)
                    },
                    contains: function(a) {
                        return b(this.element, a, !1, !1)
                    },
                    remove: function(a) {
                        b(this.element, a, !1, !0)
                    },
                    toggle: function(a) {
                        b(this.element, a, !0, !0)
                    }
                };
                Object.defineProperty(HTMLElement.prototype, "classList", {
                    get: function() {
                        if (this._classList) return this._classList;
                        var a = Object.create(e, {
                            element: {
                                value: this,
                                writable: !1,
                                enumerable: !0
                            }
                        });
                        Object.defineProperty(this, "_classList", {
                            value: a,
                            writable: !1,
                            enumerable: !1
                        });
                        return a
                    },
                    enumerable: !0
                })
            }
        })();
    </script>
    <script>
        /* vim: set shiftwidth=2 tabstop=2 autoindent cindent expandtab filetype=javascript : */
        /** 
         * @license pdf2htmlEX.js: Core UI functions for pdf2htmlEX
         * Copyright 2012,2013 Lu Wang <coolwanglu@gmail.com> and other contributors
         * https://github.com/coolwanglu/pdf2htmlEX/blob/master/share/LICENSE
         */

        /*
         * Attention:
         * This files is to be optimized by closure-compiler,
         * so pay attention to the forms of property names:
         *
         * string/bracket form is safe, won't be optimized:
         * var obj={ 'a':'b' }; obj['a'] = 'b';
         * name/dot form will be optimized, the name is likely to be modified:
         * var obj={ a:'b' }; obj.a = 'b';
         *
         * Either form can be used for internal objects,
         * but must be consistent for each one respectively.
         *
         * string/bracket form must be used for external objects
         * e.g. DEFAULT_CONFIG, object stored in page-data
         * property names are part of the `protocol` in these cases.
         *
         */

        'use strict';

        var pdf2htmlEX = window['pdf2htmlEX'] = window['pdf2htmlEX'] || {};

        /** 
         * @const
         * @struct
         */
        var CSS_CLASS_NAMES = {
            page_frame: 'pf',
            page_content_box: 'pc',
            page_data: 'pi',
            background_image: 'bi',
            link: 'l',
            __dummy__: 'no comma'
        };

        /** 
         * configurations of Viewer
         * @const
         * @dict
         */
        var DEFAULT_CONFIG = {
            // id of the element to put the pages in
            'container_id': 'svg-container',
            // id of the element for sidebar (to open and close)
            'sidebar_id': 'sidebar',
            // id of the element for outline
            'outline_id': 'outline',
            // class for the loading indicator
            'loading_indicator_cls': 'loading-indicator',
            // How many page shall we preload that are below the last visible page
            'preload_pages': 3,
            // how many ms should we wait before actually rendering the pages and after a scroll event
            'render_timeout': 100,
            // zoom ratio step for each zoom in/out event
            'scale_step': 0.9,
            // register global key handler
            'key_handler': true,
            // register hashchange handler
            'hashchange_handler': true,

            '__dummy__': 'no comma'
        };

        /** @const */
        var EPS = 1e-6;

        /************************************/
        /* utility function */
        /**
         * @param{Array.<number>} ctm
         */
        function invert(ctm) {
            var det = ctm[0] * ctm[3] - ctm[1] * ctm[2];
            return [ctm[3] / det, -ctm[1] / det, -ctm[2] / det, ctm[0] / det, (ctm[2] * ctm[5] - ctm[3] * ctm[4]) / det, (ctm[1] * ctm[4] - ctm[0] * ctm[5]) / det];
        };
        /**
         * @param{Array.<number>} ctm
         * @param{Array.<number>} pos
         */
        function transform(ctm, pos) {
            return [ctm[0] * pos[0] + ctm[2] * pos[1] + ctm[4], ctm[1] * pos[0] + ctm[3] * pos[1] + ctm[5]];
        };

        /**
         * @param{Element} ele
         */
        function get_page_number(ele) {
            return parseInt(ele.getAttribute('data-page-no'), 16);
        };

        /**
         * @param{NodeList} eles
         */
        function disable_dragstart(eles) {
            for (var i = 0, l = eles.length; i < l; ++i) {
                eles[i].addEventListener('dragstart', function() {
                    return false;
                }, false);
            }
        };

        /**
         * @param{...Object} var_args
         */
        function clone_and_extend_objs(var_args) {
            var result_obj = {};
            for (var i = 0, l = arguments.length; i < l; ++i) {
                var cur_obj = arguments[i];
                for (var k in cur_obj) {
                    if (cur_obj.hasOwnProperty(k)) {
                        result_obj[k] = cur_obj[k];
                    }
                }
            }
            return result_obj;
        };

        /** 
         * @constructor
         * @param{Element} page The element for the page
         */
        function Page(page) {
            if (!page) return;

            this.loaded = false;
            this.shown = false;
            this.page = page; // page frame element

            this.num = get_page_number(page);

            // page size
            // Need to make rescale work when page_content_box is not loaded, yet
            this.original_height = page.clientHeight;
            this.original_width = page.clientWidth;

            // content box
            var content_box = page.getElementsByClassName(CSS_CLASS_NAMES.page_content_box)[0];

            // if page is loaded
            if (content_box) {
                this.content_box = content_box;
                /*
                 * scale ratios
                 *
                 * original_scale : the first one
                 * cur_scale : currently using
                 */
                this.original_scale = this.cur_scale = this.original_height / content_box.clientHeight;
                this.page_data = JSON.parse(page.getElementsByClassName(CSS_CLASS_NAMES.page_data)[0].getAttribute('data-data'));

                this.ctm = this.page_data['ctm'];
                this.ictm = invert(this.ctm);

                this.loaded = true;
            }
        };
        Page.prototype = {
            /* hide & show are for contents, the page frame is still there */
            hide: function() {
                if (this.loaded && this.shown) {
                    this.content_box.classList.remove('opened');
                    this.shown = false;
                }
            },
            show: function() {
                if (this.loaded && !this.shown) {
                    this.content_box.classList.add('opened');
                    this.shown = true;
                }
            },
            /**
             * @param{number} ratio
             */
            rescale: function(ratio) {
                if (ratio === 0) {
                    // reset scale
                    this.cur_scale = this.original_scale;
                } else {
                    this.cur_scale = ratio;
                }

                // scale the content box
                if (this.loaded) {
                    var cbs = this.content_box.style;
                    cbs.msTransform = cbs.webkitTransform = cbs.transform = 'scale(' + this.cur_scale.toFixed(3) + ')';
                }

                // stretch the page frame to hold the place
                {
                    var ps = this.page.style;
                    ps.height = (this.original_height * this.cur_scale) + 'px';
                    ps.width = (this.original_width * this.cur_scale) + 'px';
                }
            },
            /*
             * return the coordinate of the top-left corner of container
             * in our coordinate system
             * assuming that p.parentNode === p.offsetParent
             */
            view_position: function() {
                var p = this.page;
                var c = p.parentNode;
                return [c.scrollLeft - p.offsetLeft - p.clientLeft, c.scrollTop - p.offsetTop - p.clientTop];
            },
            height: function() {
                return this.page.clientHeight;
            },
            width: function() {
                return this.page.clientWidth;
            }
        };

        /** 
         * @constructor
         * @param{Object=} config
         */
        function Viewer(config) {
            this.config = clone_and_extend_objs(DEFAULT_CONFIG, (arguments.length > 0 ? config : {}));
            this.pages_loading = [];
            this.init_before_loading_content();

            var self = this;
            document.addEventListener('DOMContentLoaded', function() {
                self.init_after_loading_content();
            }, false);
        };

        Viewer.prototype = {
            scale: 1,
            /* 
             * index of the active page (the one with largest visible area)
             * which estimates the page currently being viewed
             */
            cur_page_idx: 0,

            /*
             * index of the first visible page
             * used when determining current view
             */
            first_page_idx: 0,

            init_before_loading_content: function() {
                /* hide all pages before loading, will reveal only visible ones later */
                this.pre_hide_pages();
            },

            init_after_loading_content: function() {
                this.sidebar = document.getElementById(this.config['sidebar_id']);
                this.outline = document.getElementById(this.config['outline_id']);
                this.container = document.getElementById(this.config['container_id']);
                this.loading_indicator = document.getElementsByClassName(this.config['loading_indicator_cls'])[0];


                {
                    // Open the outline if nonempty
                    var empty = true;
                    var nodes = this.outline.childNodes;
                    for (var i = 0, l = nodes.length; i < l; ++i) {
                        var cur_node = nodes[i];
                        if (cur_node.nodeName === 'UL') {
                            empty = false;
                            break;
                        }
                    }
                    if (!empty)
                        this.sidebar.classList.add('opened');
                }

                this.find_pages();
                // do nothing if there's nothing
                if (this.pages.length == 0) return;

                // disable dragging of background images
                disable_dragstart(document.getElementsByClassName(CSS_CLASS_NAMES.background_image));

                if (this.config['key_handler'])
                    this.register_key_handler();

                var self = this;

                if (this.config['hashchange_handler']) {
                    window.addEventListener('hashchange', function(e) {
                        self.navigate_to_dest(document.location.hash.substring(1));
                    }, false);
                }

                // register schedule rendering
                // renew old schedules since scroll() may be called frequently
                this.container.addEventListener('scroll', function() {
                    self.update_page_idx();
                    self.schedule_render(true);
                }, false);

                // handle links
                [this.container, this.outline].forEach(function(ele) {
                    ele.addEventListener('click', self.link_handler.bind(self), false);
                });

                this.render();
            },

            /*
             * set up this.pages and this.page_map
             * pages is an array holding all the Page objects
             * page-Map maps an original page number (in PDF) to the corresponding index in page
             */
            find_pages: function() {
                var new_pages = [];
                var new_page_map = {};
                var nodes = this.container.childNodes;
                for (var i = 0, l = nodes.length; i < l; ++i) {
                    var cur_node = nodes[i];
                    if ((cur_node.nodeType === Node.ELEMENT_NODE) && cur_node.classList.contains(CSS_CLASS_NAMES.page_frame)) {
                        var p = new Page(cur_node);
                        new_pages.push(p);
                        new_page_map[p.num] = new_pages.length - 1;
                    }
                }
                this.pages = new_pages;
                this.page_map = new_page_map;
            },

            /**
             * @param{number} idx
             * @param{number=} pages_to_preload
             * @param{function(Page)=} callback
             *
             * TODO: remove callback -> promise ?
             */
            load_page: function(idx, pages_to_preload, callback) {
                var pages = this.pages;
                if (idx >= pages.length)
                    return; // Page does not exist

                var cur_page = pages[idx];
                if (cur_page.loaded)
                    return; // Page is loaded

                if (this.pages_loading[idx])
                    return; // Page is already loading

                var cur_page_ele = cur_page.page;
                var url = cur_page_ele.getAttribute('data-page-url');
                if (url) {
                    this.pages_loading[idx] = true; // set semaphore

                    // add a copy of the loading indicator
                    var new_loading_indicator = this.loading_indicator.cloneNode();
                    new_loading_indicator.classList.add('active');
                    cur_page_ele.appendChild(new_loading_indicator);

                    // load data
                    {
                        var self = this;
                        var _idx = idx;
                        var xhr = new XMLHttpRequest();
                        xhr.open('GET', url, true);
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState != 4) return;
                            if (xhr.status === 200) {
                                // find the page element in the data
                                var div = document.createElement('div');
                                div.innerHTML = xhr.responseText;

                                var new_page = null;
                                var nodes = div.childNodes;
                                for (var i = 0, l = nodes.length; i < l; ++i) {
                                    var cur_node = nodes[i];
                                    if ((cur_node.nodeType === Node.ELEMENT_NODE) && cur_node.classList.contains(CSS_CLASS_NAMES.page_frame)) {
                                        new_page = cur_node;
                                        break;
                                    }
                                }

                                // replace the old page with loaded data
                                // the loading indicator on this page should also be destroyed
                                var p = self.pages[_idx];
                                self.container.replaceChild(new_page, p.page);
                                p = new Page(new_page);
                                self.pages[_idx] = p;

                                p.hide();
                                p.rescale(self.scale);

                                // disable background image dragging
                                disable_dragstart(new_page.getElementsByClassName(CSS_CLASS_NAMES.background_image));

                                self.schedule_render(false);

                                if (callback) {
                                    callback(p);
                                }
                            }

                            // Reset loading token
                            delete self.pages_loading[_idx];
                        };
                        xhr.send(null);
                    }
                }
                // Concurrent prefetch of the next pages
                if (pages_to_preload === undefined)
                    pages_to_preload = this.config['preload_pages'];

                if (--pages_to_preload > 0) {
                    var self = this;
                    setTimeout(function() {
                        self.load_page(idx + 1, pages_to_preload);
                    }, 0);
                }
            },

            /*
             * Hide all pages that have no 'opened' class
             * The 'opened' class will be added to visible pages by JavaScript
             * We cannot add this in the default CSS because JavaScript may be disabled
             */
            pre_hide_pages: function() {
                /* pages might have not been loaded yet, so add a CSS rule */
                var s = '@media screen{.' + CSS_CLASS_NAMES.page_content_box + '{display:none;}}';
                var n = document.createElement('style');
                if (n.styleSheet) {
                    n.styleSheet.cssText = s;
                } else {
                    n.appendChild(document.createTextNode(s));
                }
                document.head.appendChild(n);
            },

            /*
             * show visible pages and hide invisible pages
             */
            render: function() {
                var container = this.container;
                /* 
                 * show the pages that are 'nearly' visible -- it's right above or below the container
                 *
                 * all the y values are in the all-page element's coordinate system
                 */
                var container_min_y = container.scrollTop;
                var container_height = container.clientHeight;
                var container_max_y = container_min_y + container_height;
                var visible_min_y = container_min_y - container_height;
                var visible_max_y = container_max_y + container_height;

                var cur_page_fully_visible = false;
                var cur_page_idx = this.cur_page_idx;
                var max_visible_page_idx = cur_page_idx;
                var max_visible_ratio = 0.0;

                var pl = this.pages;
                for (var i = 0, l = pl.length; i < l; ++i) {
                    var cur_page = pl[i];
                    var cur_page_ele = cur_page.page;
                    var page_min_y = cur_page_ele.offsetTop + cur_page_ele.clientTop;
                    var page_height = cur_page_ele.clientHeight;
                    var page_max_y = page_min_y + page_height;
                    if ((page_min_y <= visible_max_y) && (page_max_y >= visible_min_y)) {
                        // cur_page is 'nearly' visible, show it or load it
                        if (cur_page.loaded) {
                            cur_page.show();
                        } else {
                            this.load_page(i);
                        }
                    } else {
                        cur_page.hide();
                    }
                }
            },
            /*
             * update cur_page_idx and first_page_idx
             * normally called upon scrolling
             */
            update_page_idx: function() {
                var pages = this.pages;
                var pages_len = pages.length;
                // there is no chance that cur_page_idx or first_page_idx is modified
                if (pages_len < 2) return;

                var container = this.container;
                var container_min_y = container.scrollTop;
                var container_max_y = container_min_y + container.clientHeight;

                // binary search for the first page
                // whose bottom border is below the top border of the container
                var first_idx = -1;
                var last_idx = pages_len;
                var rest_len = last_idx - first_idx;
                // TODO: use current first_page_idx as a hint?
                while (rest_len > 1) {
                    var idx = first_idx + Math.floor(rest_len / 2);
                    var cur_page_ele = pages[idx].page;
                    if (cur_page_ele.offsetTop + cur_page_ele.clientTop + cur_page_ele.clientHeight >= container_min_y) {
                        last_idx = idx;
                    } else {
                        first_idx = idx;
                    }
                    rest_len = last_idx - first_idx;
                }

                /*
                 * with malformed settings it is possible that no page is visible, e.g.
                 * - the container is to thin, which lies in the margin between two pages
                 * - all pages are completely above or below the container
                 * but we just assume that they won't happen.
                 */
                this.first_page_idx = last_idx;

                // find the page with largest visible area
                var cur_page_idx = this.cur_page_idx;
                var max_visible_page_idx = cur_page_idx;
                var max_visible_ratio = 0.0;

                for (var i = last_idx; i < pages_len; ++i) {
                    var cur_page_ele = pages[i].page;
                    var page_min_y = cur_page_ele.offsetTop + cur_page_ele.clientTop;
                    var page_height = cur_page_ele.clientHeight;
                    var page_max_y = page_min_y + page_height;
                    if (page_min_y > container_max_y) break;

                    // check the visible fraction of the page
                    var page_visible_ratio = (Math.min(container_max_y, page_max_y) - Math.max(container_min_y, page_min_y)) / page_height;

                    // stay with the current page if it is still fully visible
                    if ((i === cur_page_idx) && (Math.abs(page_visible_ratio - 1.0) <= EPS)) {
                        max_visible_page_idx = cur_page_idx;
                        break;
                    }

                    if (page_visible_ratio > max_visible_ratio) {
                        max_visible_ratio = page_visible_ratio;
                        max_visible_page_idx = i;
                    }
                }

                this.cur_page_idx = max_visible_page_idx;
            },

            /**
             * @param{boolean} renew renew the existing schedule instead of using the old one
             */
            schedule_render: function(renew) {
                if (this.render_timer !== undefined) {
                    if (!renew) return;
                    clearTimeout(this.render_timer);
                }

                var self = this;
                this.render_timer = setTimeout(function() {
                    /*
                     * render() may trigger load_page(), which may in turn trigger another render()
                     * so delete render_timer first
                     */
                    delete self.render_timer;
                    self.render();
                }, this.config['render_timeout']);
            },

            /*
             * Handling key events, zooming, scrolling etc.
             */
            register_key_handler: function() {
                /* 
                 * When user try to zoom in/out using ctrl + +/- or mouse wheel
                 * handle this and prevent the default behaviours
                 *
                 * Code credit to PDF.js
                 */
                var self = this;

                // Firefox specific event, so that we can prevent browser from zooming
                window.addEventListener('DOMMouseScroll', function(e) {
                    if (e.ctrlKey) {
                        e.preventDefault();
                        var container = self.container;
                        var rect = container.getBoundingClientRect();
                        var fixed_point = [e.clientX - rect['left'] - container.clientLeft, e.clientY - rect['top'] - container.clientTop];
                        self.rescale(Math.pow(self.config['scale_step'], e.detail), true, fixed_point);
                    }
                }, false);

                window.addEventListener('keydown', function(e) {
                    var handled = false;
                    /*
                    var cmd = (e.ctrlKey ? 1 : 0)
                              | (e.altKey ? 2 : 0)
                              | (e.shiftKey ? 4 : 0)
                              | (e.metaKey ? 8 : 0)
                              ;
                              */
                    var with_ctrl = e.ctrlKey || e.metaKey;
                    var with_alt = e.altKey;
                    switch (e.keyCode) {
                        case 61: // FF/Mac '='
                        case 107: // FF '+' and '='
                        case 187: // Chrome '+'
                            if (with_ctrl) {
                                self.rescale(1.0 / self.config['scale_step'], true);
                                handled = true;
                            }
                            break;
                        case 173: // FF/Mac '-'
                        case 109: // FF '-'
                        case 189: // Chrome '-'
                            if (with_ctrl) {
                                self.rescale(self.config['scale_step'], true);
                                handled = true;
                            }
                            break;
                        case 48: // '0'
                            if (with_ctrl) {
                                self.rescale(0, false);
                                handled = true;
                            }
                            break;
                        case 33: // Page UP:
                            if (with_alt) { // alt-pageup    -> scroll one page up
                                self.scroll_to(self.cur_page_idx - 1);
                            } else { // pageup        -> scroll one screen up
                                self.container.scrollTop -= self.container.clientHeight;
                            }
                            handled = true;
                            break;
                        case 34: // Page DOWN
                            if (with_alt) { // alt-pagedown  -> scroll one page down
                                self.scroll_to(self.cur_page_idx + 1);
                            } else { // pagedown      -> scroll one screen down
                                self.container.scrollTop += self.container.clientHeight;
                            }
                            handled = true;
                            break;
                        case 35: // End
                            self.container.scrollTop = self.container.scrollHeight;
                            handled = true;
                            break;
                        case 36: // Home
                            self.container.scrollTop = 0;
                            handled = true;
                            break;
                    }
                    if (handled) {
                        e.preventDefault();
                        return;
                    }
                }, false);
            },

            /**
             * @param{number} ratio
             * @param{boolean} is_relative
             * @param{Array.<number>=} fixed_point preserve the position (relative to the top-left corner of the viewer) after rescaling
             */
            rescale: function(ratio, is_relative, fixed_point) {
                var old_scale = this.scale;
                var new_scale = old_scale;
                // set new scale
                if (ratio === 0) {
                    new_scale = 1;
                    is_relative = false;
                } else if (is_relative)
                    new_scale *= ratio;
                else
                    new_scale = ratio;

                this.scale = new_scale;

                if (!fixed_point)
                    fixed_point = [0, 0];

                // translate fixed_point to the coordinate system of all pages
                var container = this.container;
                fixed_point[0] += container.scrollLeft;
                fixed_point[1] += container.scrollTop;

                // find the visible page that contains the fixed point
                // if the fixed point lies between two pages (including their borders), it's contained in the first one
                var pl = this.pages;
                var pl_len = pl.length;
                for (var i = this.first_page_idx; i < pl_len; ++i) {
                    var p = pl[i].page;
                    if (p.offsetTop + p.clientTop >= fixed_point[1])
                        break;
                }
                var fixed_point_page_idx = i - 1;

                // determine the new scroll position
                // each-value consists of two parts, one inside the page, which is affected by rescaling,
                // the other is outside, (e.g. borders and margins), which is not affected

                // if the fixed_point is above the first page, use the first page as the reference
                if (fixed_point_page_idx < 0)
                    fixed_point_page_idx = 0;

                var fp_p = pl[fixed_point_page_idx].page;
                var fp_p_width = fp_p.clientWidth;
                var fp_p_height = fp_p.clientHeight;

                var fp_x_ref = fp_p.offsetLeft + fp_p.clientLeft;
                var fp_x_inside = fixed_point[0] - fp_x_ref;
                if (fp_x_inside < 0)
                    fp_x_inside = 0;
                else if (fp_x_inside > fp_p_width)
                    fp_x_inside = fp_p_width;

                var fp_y_ref = fp_p.offsetTop + fp_p.clientTop;
                var fp_y_inside = fixed_point[1] - fp_y_ref;
                if (fp_y_inside < 0)
                    fp_y_inside = 0;
                else if (fp_y_inside > fp_p_height)
                    fp_y_inside = fp_p_height;

                // Rescale pages
                for (var i = 0; i < pl_len; ++i)
                    pl[i].rescale(new_scale);

                // Correct container scroll to keep view aligned while zooming
                container.scrollLeft += fp_x_inside / old_scale * new_scale + fp_p.offsetLeft + fp_p.clientLeft - fp_x_inside - fp_x_ref;
                container.scrollTop += fp_y_inside / old_scale * new_scale + fp_p.offsetTop + fp_p.clientTop - fp_y_inside - fp_y_ref;

                // some pages' visibility may be toggled, wait for next render()
                // renew old schedules since rescale() may be called frequently
                this.schedule_render(true);
            },

            fit_width: function() {
                var page_idx = this.cur_page_idx;
                this.rescale(this.container.clientWidth / this.pages[page_idx].width(), false);
                this.scroll_to(page_idx);
            },

            fit_height: function() {
                var page_idx = this.cur_page_idx;
                this.rescale(this.container.clientHeight / this.pages[page_idx].height(), false);
                this.scroll_to(page_idx);
            },
            /**
             * @param{Node} ele
             */
            get_containing_page: function(ele) {
                /* get the page obj containing obj */
                while (ele) {
                    if ((ele.nodeType === Node.ELEMENT_NODE) && ele.classList.contains(CSS_CLASS_NAMES.page_frame)) {
                        /*
                         * Get original page number and map it to index of pages
                         * TODO: store the index on the dom element
                         */
                        var pn = get_page_number( /** @type{Element} */ (ele));
                        var pm = this.page_map;
                        return (pn in pm) ? this.pages[pm[pn]] : null;
                    }
                    ele = ele.parentNode;
                }
                return null;
            },

            /**
             * @param{Event} e
             */
            link_handler: function(e) {
                var target = /** @type{Node} */ (e.target);
                var detail_str = /** @type{string} */ (target.getAttribute('data-dest-detail'));
                if (!detail_str) return;

                this.navigate_to_dest(detail_str, this.get_containing_page(target));
                e.preventDefault();
            },

            /**
             * @param{string} detail_str may come from user provided hashtag, need sanitzing
             * @param{Page=} src_page page containing the source event (e.g. link)
             */
            navigate_to_dest: function(detail_str, src_page) {
                try {
                    var detail = JSON.parse(detail_str);
                } catch (e) {
                    return;
                }

                if (!(detail instanceof Array)) return;

                var target_page_no = detail[0];
                var page_map = this.page_map;
                if (!(target_page_no in page_map)) return;
                var target_page_idx = page_map[target_page_no];
                var target_page = this.pages[target_page_idx];

                for (var i = 2, l = detail.length; i < l; ++i) {
                    var d = detail[i];
                    if (!((d === null) || (typeof d === 'number')))
                        return;
                }

                while (detail.length < 6)
                    detail.push(null);

                // cur_page might be undefined, e.g. from Outline
                var cur_page = src_page || this.pages[this.cur_page_idx];

                var cur_pos = cur_page.view_position();
                cur_pos = transform(cur_page.ictm, [cur_pos[0], cur_page.height() - cur_pos[1]]);

                var zoom = this.scale;
                var pos = [0, 0];
                var upside_down = true;
                var ok = false;

                // position specified in `detail` are in the raw coordinate system of the page (unscaled)
                var scale = this.scale;
                // TODO: fitb*
                // TODO: BBox
                switch (detail[1]) {
                    case 'XYZ':
                        pos = [(detail[2] === null) ? cur_pos[0] : detail[2] * scale, (detail[3] === null) ? cur_pos[1] : detail[3] * scale];
                        zoom = detail[4];
                        if ((zoom === null) || (zoom === 0))
                            zoom = this.scale;
                        ok = true;
                        break;
                    case 'Fit':
                    case 'FitB':
                        pos = [0, 0];
                        ok = true;
                        break;
                    case 'FitH':
                    case 'FitBH':
                        pos = [0, (detail[2] === null) ? cur_pos[1] : detail[2] * scale];
                        ok = true;
                        break;
                    case 'FitV':
                    case 'FitBV':
                        pos = [(detail[2] === null) ? cur_pos[0] : detail[2] * scale, 0];
                        ok = true;
                        break;
                    case 'FitR':
                        /* locate the top-left corner of the rectangle */
                        // TODO
                        pos = [detail[2] * scale, detail[5] * scale];
                        upside_down = false;
                        ok = true;
                        break;
                    default:
                        break;
                }

                if (!ok) return;

                this.rescale(zoom, false);


                var self = this;
                /**
                 * page should of type Page
                 * @param{Page} page
                 */
                var transform_and_scroll = function(page) {
                    pos = transform(page.ctm, pos);
                    if (upside_down) {
                        pos[1] = page.height() - pos[1];
                    }
                    self.scroll_to(target_page_idx, pos);
                };

                if (target_page.loaded) {
                    transform_and_scroll(target_page);
                } else {
                    // TODO: scroll_to may finish before load_page

                    // Scroll to the exact position once loaded.
                    this.load_page(target_page_idx, undefined, transform_and_scroll);

                    // In the meantime page gets loaded, scroll approximately position for maximum responsiveness.
                    this.scroll_to(target_page_idx);
                }
            },

            /**
             * @param{number} page_idx
             * @param{Array.<number>=} pos [x,y] where (0,0) is the top-left corner
             */
            scroll_to: function(page_idx, pos) {
                var pl = this.pages;
                if ((page_idx < 0) || (page_idx >= pl.length)) return;
                var target_page = pl[page_idx];
                var cur_target_pos = target_page.view_position();

                if (pos === undefined)
                    pos = [0, 0];

                var container = this.container;
                container.scrollLeft += pos[0] - cur_target_pos[0];
                container.scrollTop += pos[1] - cur_target_pos[1];
            }
        };

        // export pdf2htmlEX.Viewer
        pdf2htmlEX['Viewer'] = Viewer;
    </script>
    <script>
        try {
            pdf2htmlEX.defaultViewer = new pdf2htmlEX.Viewer({});
        } catch (e) {}
    </script>


    <title></title>
</head>

<body>

    <div id="loading" >

        <img id="loading-image" src="../images/ajax-loader.gif" alt="Loading..." />

    </div>

    <div id="template-attributes" style="position: fixed;
top: 55px;
background: white;
height: 40px;
padding: 10px 25px;
width: 100%;
z-index: 2;">

<div id = "filenameInTemplate">{{templateFilename}}</div>

</div>


    <div id="tools-container" style="position: fixed;
top: 95px;
background: white;
height: auto;
padding: 5px 20px;
width: 100%;
z-index: 20;
box-shadow: 3px 6px 8px #888;
">

        <div class="tool-type">
            <input type="checkbox" id="strike" name="chk" onclick="check_value('strike')">
            <label for="strike"><i class="fa fa-strikethrough" style="float:left"></i>
                <div style="float:left;font-weight:200">&nbsp;Strike</div>
            </label>

        </div>
        <div class="tool-type">
            <input type="checkbox" id="highlight" onclick="check_value('highlight')">
            <label for="highlight"><i class="fa fa-paint-brush" style="float:left"></i>
                <div style="float:left;font-weight:200">&nbsp;Highlight</div>
            </label>
        </div>
        <div class="tool-type">
            <input type="checkbox" id="draw" onclick="check_value('draw')">
            <label for="draw"><i class="fa fa-pencil" style="float:left"></i>
                <div class="unselectable" style="float:left;font-weight:200">&nbsp;Draw</div>
            </label>
        </div>
        <div class="tool-type">
            <input type="checkbox" id="textbox" onclick="check_value('textbox')">
            <label for="textbox"><i class="fa fa-pencil-square-o" style="float:left"></i>
                <div style="float:left;font-weight:200">&nbsp;Text box</div>
            </label>
        </div>
        <div class="tool-type">
            <input type="checkbox" id="drop-comment" onclick="check_value('drop-comment')">
            <label for="drop-comment"><i class="fa fa-thumb-tack" style="float:left"></i>
                <div style="float:left;font-weight:200">&nbsp;Pin comment</div>
            </label>
        </div>
        <div class="tool-type">
            <input type="checkbox" id="drag-comment" onclick="check_value('drag-comment')">
            <label for="drag-comment"><i class="fa fa-comment" style="float:left"></i>
                <div style="float:left;font-weight:200;">&nbsp;Text comment</div>
            </label>
        </div>

        <div style="display:inline-block;float:right">
        <a href="#/workgroups/{{wg}}/{{uniqueFilename}}/activity" class="btn btn-warning btn-small"><i class="fa fa-bar-chart"></i>&nbsp;View activity</a>
    </div>

    </div>
    <div id="title" style="display:none;position:fixed;top:0px;left:0px;width:100%;height:35px;background-color: black; z-index:20 ;text-align:left;line-height: 35px;color:white;">

        <div id="del-info">
            <button class="close_info" type="button">
                <span></span>
                <span class="close_area">Close</span>
            </button>
            To delete an annotation: Select its type from tools, then right-click on the annotation
        </div>

        <div id="doc_name" style="text-align:center;font-size:14px;font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;"><img style="display: inline-block; vertical-align: sub;" src="../images/doc_name.png">
            <?php echo $_GET[ 'file']; ?>
        </div>
        <div id="page-text" style="position:absolute;top:0px;left:205px; color: white; -webkit-user-select: text;font-size:14px;font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;">Page:</div>
        <input id="page_no" type="text" onkeypress="return isNumber(event)" name="fname" style="margin-top: 6px;
width: 30px;
height: 12px;
font-size: 9pt;
position: absolute;
top: 5px;
-webkit-user-select: text;
left: 243px;
outline: none;
background-color: rgba(203, 198, 198, 0.8);
text-align: center;
border-radius: 4px;
opacity: 0.;
border: none;
color: white;
font-weight:bold;
font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;">


        <img id="page-up" style="position:absolute;top:11px;left:276px;cursor: pointer; -webkit-user-select: text;" src="../images/up15.png">
        </td>
        <img id="page-down" style="position:absolute;top:11px;left:294px;cursor: pointer; -webkit-user-select: text;" src="../images/down15.png">


       
        <div class="header-panel-btn" id="clear-all-history" style="position:absolute; top:4px; right: 94px; height:25px; width:68px;" onclick="if(confirm('Are you sure you want to delete all your annotations?')) clear_all_history(); else return false">Clear All</div>
        <div class="header-panel-btn" id="tour" style="position:absolute; top:4px; right: 170px; height:25px; width:68px;" onclick="javascript:introJs().start();">Tour</div>


    </div>


   <!--  <div id="sidebar" class="opened">

        
     </div>
 -->

       

            <div class="highlight_colors" style="display:none;
                                                position: absolute;
                                                top: 137px;
                                                left: 90px;
                                                z-index: 20;
                                                padding: 4px 4px;
                                                background: white;
                                                border: 1px solid grey;">
                <input type="radio" id="highlight_red" onclick="check_value('highlight_red')">
                <label for="highlight_red">
                    <div id="red_circle">
                            <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="highlight_blue" onclick="check_value('highlight_blue')">
                <label for="highlight_blue">
                    <div id="blue_circle">
                            <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="highlight_green" onclick="check_value('highlight_green')">
                <label for="highlight_green">
                    <div id="green_circle">
                                <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="highlight_yellow" onclick="check_value('highlight_yellow')">
                <label for="highlight_yellow">
                    <div id="yellow_circle">
                                <i class="fa fa-check"></i>
                    </div>
                </label>
            </div>

           

            <div class="draw_colors" style="display: none;
                                            position: absolute;
                                            top: 137px;
                                            left: 177px;
                                            z-index: 20;
                                            padding: 4px;
                                            border: 1px solid grey;
                                            background: white;">
                <input type="radio" id="draw_black" onclick="check_value('draw_black')">
                <label for="draw_black">
                    <div id="black_draw">
                                 <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="draw_red" onclick="check_value('draw_red')">
                <label for="draw_red">
                    <div id="red_draw">
                                 <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="draw_green" onclick="check_value('draw_green')">
                <label for="draw_green">
                    <div id="green_draw">
                                 <i class="fa fa-check"></i>
                    </div>
                </label>
                <input type="radio" id="draw_blue" onclick="check_value('draw_blue')">
                <label for="draw_blue">
                    <div id="blue_draw">
                                 <i class="fa fa-check"></i>
                    </div>
                </label>
            </div>

<div style="z-index:20">
      <div id="display-history" style="position:absolute;top:280px;left:10px;">	</div>
        <!-- <div id ="count-history" style="position:absolute;top:287px;left:141px;color:white;font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;font-size:10pt"></div> -->
        <div id="down-drop" style="display:none;pointer-events:none;cursor:pointer;position:absolute;top:293px;left:152px;width: 0;height: 0;font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;border-left: 6px solid transparent;border-right: 6px solid transparent;border-top: 6px solid white;"></div>
        <div id="up-pull" style="display:none;pointer-events:none;cursor:pointer;position:absolute;top:293px;left:152px;width: 0;height: 0;font-family: Calibri, Candara, Segoe, Segoe UI, Optima, Arial, sans-serif;border-left: 6px solid transparent;border-right: 6px solid transparent;border-bottom: 6px solid white;"></div>



        <div id="count-history" style="position:absolute;top:271px;left:177px;"></div>

        <div id="history-container" style="position:relative;top:287px;left:10px;overflow:hidden;width:180px;height:280px">
            <ul id="history" style="position:relative;padding:0px;margin:0px;top:0px;left:0px;width:180px;height:281px;">

            </ul>
        </div>      
</div>


    <div id="page-container" style="margin-top: 100px;" >
        <div id="image-container" style="position:absolute;left:0px;width:100%;height:100%"></div>
        <div id="svg-container" class="clickable">



        </div>

        <div id="connector-container">
            <svg id="connector-svg" style="overflow:visible" height="100%" width="100%">


            </svg>
        </div>
        <div id="comment-container">
        </div>
    </div>
 
    <div id="intro-modal" onclick="hideintro();"></div>


     <!-- <script type="text/javascript" src="../javascripts/socket.io.js"></script> -->
    


    <script language="javascript" type="text/javascript">
        var userId = "<?php echo $_SESSION['userid']?>";
        
var n = window.location.href;
var shareId = window.location.href.slice(-15);
var s = window.location.href.slice(n.lastIndexOf("/")+1,-15);

      // var socket;

      // socket.disconnect();

      // $(window).load(function(){     //Without this working fine 7th Jan 2015

            
        

        // socket = io.connect("http://192.168.0.104:9000");
// });


        // socket.on("connect", socketConnected);
        // socket.on("getChangeData", getChangeData);


$(document).ready(function() {
 // executes when complete page is fully loaded, including all frames, objects and images


setTimeout(function(){ // a 500ms timeout given so that it lands on the page then pulls the data





        var request = $.ajax({
            url: "https://s3-ap-southeast-1.amazonaws.com/documendz-ent/uploaded/user_"+s+"/converts/"+shareId+".html",
            type: "GET",
            cache: true,
            async: false
        });


        request.done(function(data) {

 

            $("#svg-container").ready(function() {


                $("#svg-container").html(data);
               

              //  console.log("jdhd");


            });


        });

        request.fail(function() {

            //console.log("error Pulling File");
            alert("Oops! There seems to be something wrong. Please try again");
        });



        var pullRequest = $.ajax({
            url: "https://documendz.com:9000/pulldata/annotationdata/" + shareId,
            type: "GET",
            cache: false
        });



        pullRequest.done(function(data) {

           
             align_page();
$('#loading').css({display:"none"});
            
            if (data.error) {
                console.log("Server Error Pulling data");

            } else if (data.data.length === 0) {
                console.log("No Data");
            } else {

                $("svg-container").ready(function() {

                    parseData(data.data[0]);


                });

            }

        });

        pullRequest.fail(function() {

            console.log("failed to pull");
        });



        //history REady ! pull History From server

        $("#display-history").ready(function() {

            var pullHistoryRequest = $.ajax({
                url: "https://documendz.com:9000/pulldata/historydata/" + shareId,
                type: "GET",
                cache: false,
            });

            pullHistoryRequest.done(function(data) {
                if (data.error) {

                    console.log("Server Error Pulling data")
                } else if (data.data.length === 0) {
                    console.log("No Data");
                } else {


                    $.each(data.data[0].history, function(index, value) {

                        add_history_realtime(value.append_class, value.append_text, value.page_no, value.anno_type, value.time, value.userName);
                    });
                }

            });

            pullHistoryRequest.fail(function() {

                console.log("Error Pulling History");
            });

        });

   },500);

});     
    </script>

</body>

</html>